<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shopping Cart - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          accent: '#cda45e',
          'accent-light': '#e5b66a',
          'accent-dark': '#b8924e',
          dark: '#1a1a1a',
          'dark-light': '#2d2d2d',
          'light-bg': '#fef9f3',
          'cream': '#f5e9da',
        },
        fontFamily: {
          Inter: ['Inter', 'sans-serif'],
        }
      }
    }
  }
</script>

<style>
@font-face {
  font-family: 'Quiapo';
  src: url('assets/fonts/Quiapo_Free.ttf') format('opentype');
}

body {
  font-family: 'Inter', sans-serif;
}

.font-quiapo {
  font-family: 'Quiapo', 'Inter', sans-serif;
}

.glass-effect {
  backdrop-filter: blur(10px);
}

.smooth-scroll {
  scroll-behavior: smooth;
}

::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #cda45e;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #b8924e;
}

.pattern-bg {
  background-color: #fef3f3;
  background-image: 
    radial-gradient(circle at 25% 25%, rgba(205, 164, 94, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 75% 75%, rgba(205, 164, 94, 0.03) 0%, transparent 50%);
}

.step-inactive { opacity: 0.4; }
.step-active { 
  background: linear-gradient(135deg, #cda45e 0%, #e5b66a 100%);
  color: white;
}
.step-complete { 
  background: #10b981;
  color: white;
}

#location-map { 
  height: 300px; 
  border-radius: 12px; 
  z-index: 1;
}

.payment-option {
  transition: all 0.3s ease;
  cursor: pointer;
}

.payment-option:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(205, 164, 94, 0.2);
}

.payment-option:has(input:checked) {
  border-color: #cda45e;
  background: linear-gradient(135deg, #fef9f3 0%, #f5e9da 100%);
  box-shadow: 0 4px 12px rgba(205, 164, 94, 0.3);
}

@keyframes slideIn {
  from { opacity: 0; transform: translateX(20px); }
  to { opacity: 1; transform: translateX(0); }
}
.animate-slide { animation: slideIn 0.3s ease-out; }

.cart-item {
  transition: all 0.3s ease;
}

.cart-item:hover {
  transform: translateX(5px);
  box-shadow: 0 4px 12px rgba(205, 164, 94, 0.15);
}

.input-field {
  transition: all 0.3s ease;
}

.input-field:focus {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(205, 164, 94, 0.2);
}

.leaflet-container {
  z-index: 1 !important;
}

.leaflet-pane {
  z-index: 400 !important;
}

.leaflet-control {
  z-index: 800 !important;
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 9999;
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.loader {
  border: 3px solid #f3f3f3;
  border-top: 3px solid #cda45e;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  animation: spin 1s linear infinite;
  display: inline-block;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
</head>

<body class="bg-light-bg pattern-bg smooth-scroll">

<!-- HEADER / NAVIGATION -->
<header class="sticky top-0 z-50 glass-effect bg-white/80 shadow-md transition-all duration-300">
  <nav class="max-w-full mx-auto px-6 lg:px-12">
    <div class="flex justify-between items-center h-20">
      <div class="flex items-center space-x-3 animate-fade-in flex-shrink-0">
        <a href="index.html" class="flex items-center space-x-3">
          <img 
            src="assets/images/logo1.png" 
            alt="Kusina ni Katya Logo" 
            class="w-14 h-14 object-contain rounded-full shadow-lg"
          />
        </a>
        <div class="hidden sm:block">
          <h1 class="font-quiapo text-2xl font-bold text-accent tracking-widest">Kusina ni Katya</h1>
          <p class="text-xs text-gray-600">Authentic Filipino Cuisine</p>
        </div>
      </div>

      <div class="hidden lg:flex items-center space-x-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium transition-colors duration-300 text-[15px]">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium transition-colors duration-300 text-[15px]">Menu</a>
        <a href="orders.html" class="text-dark-light hover:text-accent font-medium transition-colors duration-300 text-[15px]">Orders</a>
        <a href="contact.html" class="text-dark-light hover:text-accent font-medium transition-colors duration-300 text-[15px]">Contact</a>
        
        <a href="cart.html" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg hover:scale-105 transition-all duration-300 text-[13px]">
          üõí View Cart (<span id="cart-count">0</span>)
        </a>

        <div id="auth-buttons" class="flex items-center gap-2">
          <a href="login.html" class="px-5 py-2.5 bg-white border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white hover:shadow-lg hover:scale-105 transition-all duration-300 text-[13px]">Log In</a>
          <a href="signup.html" class="px-5 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg hover:scale-105 transition-all duration-300 text-[13px]">Sign Up</a>
        </div>

        <div id="user-profile" class="hidden items-center gap-2">
          <a href="profile.html" class="flex items-center space-x-2 px-3 py-2 bg-accent/10 rounded-full hover:bg-accent/20 transition-all duration-300 cursor-pointer">
            <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
              <span id="user-initial" class="text-white font-bold text-xs">U</span>
            </div>
            <span id="user-name" class="text-dark font-semibold text-[13px]">User</span>
          </a>
          <button onclick="logout()" class="px-5 py-2.5 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 hover:shadow-lg hover:scale-105 transition-all duration-300 text-[13px]">Logout</button>
        </div>
      </div>

      <button onclick="toggleMobileMenu()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors duration-300" id="mobile-menu-btn">
        <svg class="w-6 h-6 text-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>

    <div id="mobile-menu" class="hidden lg:hidden pb-6 animate-slide-up">
      <div class="flex flex-col space-y-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium py-2 transition-colors duration-300">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium py-2 transition-colors duration-300">Menu</a>
        <a href="orders.html" class="text-dark-light hover:text-accent font-medium py-2 transition-colors duration-300">Orders</a>
        <a href="cart.html" class="text-accent font-medium py-2">üõí Cart (<span id="mobile-cart-count">0</span>)</a>
        <a href="contact.html" class="text-dark-light hover:text-accent font-medium py-2 transition-colors duration-300">Contact</a>
        
        <div id="mobile-auth-buttons" class="flex flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="login.html" class="px-6 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg hover:scale-105 transition-all duration-300 text-center">Log In</a>
          <a href="signup.html" class="px-6 py-2.5 border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white hover:shadow-lg hover:scale-105 transition-all duration-300 text-center">Sign Up</a>
        </div>

        <div id="mobile-user-profile" class="hidden flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="profile.html" class="flex items-center space-x-3 px-4 py-2 bg-accent/10 rounded-full hover:bg-accent/20 transition-all duration-300">
            <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
              <span id="mobile-user-initial" class="text-white font-bold">U</span>
            </div>
            <span id="mobile-user-name" class="text-dark font-semibold">User</span>
          </a>
          <button onclick="logout()" class="px-6 py-2.5 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 hover:shadow-lg hover:scale-105 transition-all duration-300 text-center">Logout</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- MAIN -->
<section class="py-8 px-4">
  <div class="max-w-6xl mx-auto">
    
    <!-- Progress Steps -->
    <div class="mb-8 bg-white rounded-2xl p-6 shadow-lg animate-fade-in">
      <div class="flex items-center justify-between max-w-2xl mx-auto">
        <div class="flex flex-col items-center flex-1">
          <div id="step-1-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-active mb-2 transition-all shadow-lg">1</div>
          <span class="text-sm font-semibold text-gray-700">Cart</span>
        </div>
        <div class="h-1 flex-1 bg-gray-200 mx-2 rounded-full"></div>
        <div class="flex flex-col items-center flex-1">
          <div id="step-2-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all">2</div>
          <span class="text-sm font-semibold text-gray-700">Details</span>
        </div>
        <div class="h-1 flex-1 bg-gray-200 mx-2 rounded-full"></div>
        <div class="flex flex-col items-center flex-1">
          <div id="step-3-indicator" class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all">3</div>
          <span class="text-sm font-semibold text-gray-700">Payment</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <!-- Main Content Area -->
      <div class="lg:col-span-2">
        
        <!-- STEP 1: Cart Review -->
        <div id="step-1" class="bg-white rounded-2xl p-6 shadow-lg animate-slide">
          <h2 class="text-3xl font-bold mb-6 text-dark">
            <span class="text-accent">Your Cart</span>
          </h2>
          <div id="cart-items" class="space-y-4"></div>
          <div id="empty-cart" class="hidden text-center py-12">
            <svg class="w-24 h-24 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <p class="text-gray-400 text-xl mb-4 font-semibold">Cart is empty</p>
            <a href="menu.html" class="inline-block px-8 py-3 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-xl hover:scale-105 transition-all duration-300">
              Browse Menu ‚Üí
            </a>
          </div>
          <button onclick="goToStep(2)" id="continue-to-details-btn" class="mt-6 w-full bg-gradient-to-r from-accent to-accent-dark text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl hover:scale-105 transition-all duration-300">
            Continue to Details ‚Üí
          </button>
        </div>

        <!-- STEP 2: Customer & Delivery Info -->
        <div id="step-2" class="hidden bg-white rounded-2xl p-6 shadow-lg animate-slide">
          <h2 class="text-3xl font-bold mb-6 text-dark">
            <span class="text-accent">Delivery & Contact</span>
          </h2>
          
          <!-- Delivery Option -->
          <div class="mb-6">
            <label class="block font-bold mb-3 text-dark text-lg">Delivery Option</label>
            <div class="grid grid-cols-2 gap-4">
              <label class="payment-option border-2 rounded-xl p-6 cursor-pointer">
                <input type="radio" name="delivery-option" value="delivery" checked onchange="toggleDeliveryFields()" class="hidden">
                <div class="text-center">
                  <div class="text-4xl mb-3">üöö</div>
                  <div class="font-bold text-lg text-dark">Delivery</div>
                  <div class="text-sm text-gray-500 mt-1">‚Ç±30 fee</div>
                </div>
              </label>
              <label class="payment-option border-2 rounded-xl p-6 cursor-pointer">
                <input type="radio" name="delivery-option" value="pickup" onchange="toggleDeliveryFields()" class="hidden">
                <div class="text-center">
                  <div class="text-4xl mb-3">üè™</div>
                  <div class="font-bold text-lg text-dark">Pickup</div>
                  <div class="text-sm text-gray-500 mt-1">Free</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Delivery Address -->
          <div id="delivery-address-section" class="mb-6">
            <label class="block font-bold mb-2 text-dark">Delivery Address</label>
            <textarea id="delivery-address" rows="3" placeholder="Enter your complete delivery address" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none"></textarea>
            <button onclick="getCurrentLocation()" class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-600 transition-all duration-300 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              Use Current Location
            </button>
            <div id="location-map-container" class="hidden mt-4 rounded-xl overflow-hidden border-2 border-gray-200">
              <div id="location-map"></div>
              <div class="bg-white p-3 border-t-2 border-gray-200">
                <p class="text-xs text-gray-600">üìç <span id="location-coords" class="font-semibold">Location detected</span></p>
              </div>
            </div>
          </div>

          <!-- Contact Info -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block font-bold mb-2 text-dark">Name</label>
              <input type="text" id="customer-name" placeholder="Full Name" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
            </div>
            <div>
              <label class="block font-bold mb-2 text-dark">Phone</label>
              <input type="tel" id="customer-phone" placeholder="Phone number" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
            </div>
          </div>

          <div class="mb-6">
            <label class="block font-bold mb-2 text-dark">Email</label>
            <input type="email" id="customer-email" placeholder="Email address" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none">
          </div>

          <div class="flex gap-3">
            <button onclick="goToStep(1)" class="flex-1 border-2 border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all duration-300">
              ‚Üê Back
            </button>
            <button onclick="goToStep(3)" class="flex-1 bg-gradient-to-r from-accent to-accent-dark text-white py-3 rounded-xl font-bold hover:shadow-xl hover:scale-105 transition-all duration-300">
              Continue to Payment ‚Üí
            </button>
          </div>
        </div>

        <!-- STEP 3: Payment -->
        <div id="step-3" class="hidden bg-white rounded-2xl p-6 shadow-lg animate-slide">
          <h2 class="text-3xl font-bold mb-6 text-dark">
            <span class="text-accent">Payment Method</span>
          </h2>
          
          <!-- Payment Options -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <label class="payment-option border-2 rounded-xl p-6 cursor-pointer">
              <input type="radio" name="payment-method" value="card" checked onchange="togglePaymentForm()" class="hidden">
              <div class="text-center">
                <div class="text-4xl mb-3">üí≥</div>
                <div class="font-bold text-lg text-dark">Card</div>
                <div class="text-xs text-gray-500 mt-1">Visa, Mastercard</div>
              </div>
            </label>
            <label class="payment-option border-2 rounded-xl p-6 cursor-pointer">
              <input type="radio" name="payment-method" value="gcash" onchange="togglePaymentForm()" class="hidden">
              <div class="text-center">
                <div class="mb-2 flex justify-center">
                  <img src="assets/images/gcashlogo.png" alt="GCash" class="h-12 w-auto object-contain">
                </div>
                <div class="font-bold text-sm text-dark">GCash</div>
                <div class="text-xs text-gray-500 mt-1">E-wallet</div>
              </div>
            </label>
          </div>

          <!-- Card Form -->
          <div id="card-payment-form" class="space-y-4 mb-6">
            <input type="text" id="card-number" placeholder="Card Number" maxlength="19" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="formatCardNumber(this)">
            <div class="grid grid-cols-2 gap-3">
              <input type="text" id="card-expiry" placeholder="MM/YY" maxlength="5" class="input-field px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="formatExpiry(this)">
              <input type="text" id="card-cvc" placeholder="CVC" maxlength="3" class="input-field px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            </div>
            <input type="text" id="card-name" placeholder="Cardholder Name" class="input-field w-full px-4 py-3 border-2 rounded-xl focus:border-accent focus:outline-none uppercase">
            <p class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">üí° Test Card: 4343 4343 4343 4345</p>
          </div>

          <!-- GCash Info -->
          <div id="gcash-payment-info" class="hidden mb-6 p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border-2 border-blue-200">
            <div class="flex items-start gap-4">
              <img src="assets/images/gcashlogo.png" class="w-16 h-16 object-contain flex-shrink-0">
              <div>
                <h4 class="font-bold text-dark mb-2 text-lg">GCash Payment</h4>
                <p class="text-sm text-gray-700">You will be redirected to GCash to complete your payment securely.</p>
              </div>
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="goToStep(2)" class="flex-1 border-2 border-gray-300 py-3 rounded-xl font-bold hover:bg-gray-50 transition-all duration-300">
              ‚Üê Back
            </button>
            <button onclick="initiateCheckout()" id="checkout-btn" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-bold hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2">
              <span>Complete Order</span>
              <span>‚úì</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Order Summary Sidebar -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-2xl p-6 shadow-lg sticky top-24 animate-fade-in">
          <h3 class="text-2xl font-bold mb-6 text-dark">
            <span class="text-accent">Order Summary</span>
          </h3>
          
          <!-- Voucher -->
          <div class="mb-6">
            <label class="block font-bold mb-2 text-dark text-sm">Have a voucher?</label>
            <div class="flex gap-2">
              <input type="text" id="voucher-input" placeholder="Enter code" class="flex-1 px-3 py-2 border-2 rounded-lg text-sm uppercase focus:border-accent focus:outline-none">
              <button onclick="applyVoucher()" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white rounded-lg text-sm font-bold hover:shadow-lg transition-all duration-300">Apply</button>
            </div>
            <div id="applied-voucher-display" class="hidden mt-3 p-3 bg-green-50 rounded-lg border-2 border-green-200">
              <div class="flex justify-between items-center">
                <div>
                  <span id="voucher-code" class="text-green-700 font-bold text-sm"></span>
                  <p class="text-xs text-green-600 mt-1">Discount applied!</p>
                </div>
                <button onclick="removeVoucher()" class="text-red-500 text-xs font-semibold hover:text-red-700">Remove</button>
              </div>
            </div>
          </div>

          <!-- Price Breakdown -->
          <div class="space-y-3 py-4 border-t-2 border-b-2 border-gray-100">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Subtotal</span>
              <span id="subtotal" class="font-semibold text-dark">‚Ç±0.00</span>
            </div>
            <div id="voucher-discount-row" class="hidden flex justify-between text-sm text-green-600">
              <span>Discount</span>
              <span id="voucher-discount" class="font-semibold">-‚Ç±0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Delivery</span>
              <span id="delivery-fee" class="font-semibold text-dark">‚Ç±30.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Tax (12%)</span>
              <span id="tax" class="font-semibold text-dark">‚Ç±0.00</span>
            </div>
          </div>

          <div class="flex justify-between text-2xl font-bold mt-6">
            <span class="text-dark">Total</span>
            <span id="total" class="text-accent">‚Ç±0.00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const DELIVERY_FEE = 30;
const TAX_RATE = 0.12;
const API_URL = window.location.hostname === 'localhost' 
  ? 'http://localhost:3000/api' 
  : '/api';

console.log('üîß API_URL:', API_URL);

// ============================================
// GLOBAL STATE
// ============================================
let cart = [];
let appliedVoucher = null;
let userLocation = null;
let locationMap = null;
let locationMarker = null;
let currentStep = 1;
let socket = null;
let socketEventListenersAdded = false;

// ============================================
// AUTH & USER UTILITIES
// ============================================
function getCartKey() {
  try {
    const userStr = localStorage.getItem('currentUser');
    if (!userStr || userStr === 'null' || userStr === 'undefined') {
      return 'kusinaCart_guest';
    }
    
    const user = JSON.parse(userStr);
    if (user && user.email) {
      return `kusinaCart_${user.email}`;
    }
    
    return 'kusinaCart_guest';
  } catch (e) {
    console.error('Error in getCartKey:', e);
    return 'kusinaCart_guest';
  }
}

function getCurrentUser() {
  try {
    const userStr = localStorage.getItem('currentUser');
    if (!userStr || userStr === 'null') {
      return null;
    }
    
    const user = JSON.parse(userStr);
    
    if (!user || !user.email) {
      console.warn('‚ö†Ô∏è Invalid user data in localStorage');
      return null;
    }
    
    console.log('‚úÖ Current user:', user.email, 'Role:', user.role);
    return user;
  } catch (e) {
    console.error('‚ùå Error parsing user data:', e);
    return null;
  }
}

function getAuthToken() {
  let token = sessionStorage.getItem('authToken');
  if (!token) {
    token = localStorage.getItem('authToken');
  }
  if (!token) {
    token = localStorage.getItem('adminToken');
  }
  
  console.log('üîë Token found:', token ? 'Yes' : 'No');
  return token;
}

function isUserAuthenticated() {
  const user = getCurrentUser();
  const token = getAuthToken();
  
  const isAuth = !!(user && user.email && token);
  
  console.log('üîç Auth check:', {
    hasUser: !!user,
    hasEmail: !!(user && user.email),
    hasToken: !!token,
    isAuthenticated: isAuth
  });
  
  return isAuth;
}

function updateUIForAuthenticatedUser() {
  const user = getCurrentUser();
  if (!user) return;

  // Desktop
  const authButtons = document.getElementById('auth-buttons');
  const userProfile = document.getElementById('user-profile');
  
  if (authButtons) authButtons.classList.add('hidden');
  if (userProfile) {
    userProfile.classList.remove('hidden');
    userProfile.classList.add('flex');
  }
  
  const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
  const userInitial = document.getElementById('user-initial');
  const userName = document.getElementById('user-name');
  
  if (userInitial) userInitial.textContent = initial;
  if (userName) userName.textContent = user.name || 'User';

  // Mobile
  const mobileAuthButtons = document.getElementById('mobile-auth-buttons');
  const mobileUserProfile = document.getElementById('mobile-user-profile');
  
  if (mobileAuthButtons) mobileAuthButtons.classList.add('hidden');
  if (mobileUserProfile) {
    mobileUserProfile.classList.remove('hidden');
    mobileUserProfile.classList.add('flex');
  }
  
  const mobileUserInitial = document.getElementById('mobile-user-initial');
  const mobileUserName = document.getElementById('mobile-user-name');
  
  if (mobileUserInitial) mobileUserInitial.textContent = initial;
  if (mobileUserName) mobileUserName.textContent = user.name || 'User';

  console.log('‚úÖ UI updated for authenticated user:', user.name);
}

function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  if (menu) {
    menu.classList.toggle('hidden');
  }
}

function logout() {
  if (!confirm('Are you sure you want to logout?')) return;
  
  localStorage.removeItem('currentUser');
  localStorage.removeItem('authToken');
  sessionStorage.removeItem('authToken');
  localStorage.removeItem('adminToken');
  
  const cartKey = getCartKey();
  localStorage.removeItem(cartKey);
  
  console.log('üëã User logged out');
  window.location.href = 'login.html';
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const colors = {
    success: 'border-l-4 border-green-500',
    error: 'border-l-4 border-red-500',
    info: 'border-l-4 border-blue-500',
    warning: 'border-l-4 border-yellow-500'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${colors[type] || colors.info} mb-4`;
  toast.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="flex-1">
        <p class="text-sm font-semibold text-dark">${escapeHtml(message)}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 5000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ============================================
// SOCKET.IO INITIALIZATION
// ============================================
function initializeSocket() {
  if (socket && socket.connected) {
    console.log('‚úÖ Socket already connected');
    return;
  }

  const token = getAuthToken();
  const user = getCurrentUser();
  
  if (!token || !user) {
    console.log('‚ö†Ô∏è No auth token or user for socket connection');
    return;
  }

  try {
    const socketUrl = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : window.location.origin;
      
    socket = io(socketUrl, {
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      transports: ['websocket', 'polling'],
      auth: { token: token },
      timeout: 10000
    });

    socket.on('connect', () => {
      console.log('üîå Socket connected:', socket.id);
      
      if (user && user.id) {
        socket.emit('join-user', { userId: user.id });
        console.log(`‚úÖ Joined room: user-${user.id}`);
      }
    });

    socket.on('disconnect', (reason) => {
      console.log('‚ùå Socket disconnected:', reason);
      
      if (reason === 'io server disconnect') {
        socket.connect();
      }
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket connection error:', error.message);
      if (error.message.includes('unauthorized')) {
        console.error('Socket auth failed - token may be invalid');
      }
    });

    socket.on('reconnect', (attemptNumber) => {
      console.log('‚úÖ Socket reconnected after', attemptNumber, 'attempts');
      if (user && user.id) {
        socket.emit('join-user', { userId: user.id });
      }
    });

    socket.on('reconnect_failed', () => {
      console.error('‚ùå Socket reconnection failed');
      showToast('Connection lost. Please refresh the page.', 'warning');
    });

    if (!socketEventListenersAdded) {
      socket.on('voucher-updated', handleVoucherUpdate);
      socket.on('order-status-changed', handleOrderStatusChanged);
      socket.on('order-updated', handleOrderUpdate);
      
      socketEventListenersAdded = true;
      console.log('‚úÖ Socket event listeners registered');
    }

  } catch (error) {
    console.error('‚ùå Socket initialization error:', error);
  }
}

function handleVoucherUpdate(payload) {
  console.log('üéüÔ∏è Voucher update received:', payload);
  
  if (appliedVoucher && payload.action === 'deleted' && payload.voucher.id === appliedVoucher.id) {
    removeVoucher();
    showToast('Your applied voucher has been removed', 'warning');
  }
  
  if (payload.action === 'created') {
    showToast(`New voucher available: ${payload.voucher.code}`, 'success');
  }
}

function handleOrderStatusChanged(payload) {
  console.log('üìÑ Order status changed:', payload);
  
  const orderId = payload.orderId || payload.order_id;
  const status = payload.status || payload.delivery_status;
  
  if (orderId && status) {
    showToast(`Order #${orderId}: ${status}`, 'info');
  }
}

function handleOrderUpdate(payload) {
  console.log('üì¶ Order update received:', payload);
}

// ============================================
// CART MANAGEMENT
// ============================================
function loadCartFromStorage() {
  const cartKey = getCartKey();
  const saved = localStorage.getItem(cartKey);
  cart = saved ? JSON.parse(saved) : [];
  
  console.log('üõí Cart loaded from:', cartKey, '- Items:', cart.length);
  
  updateCartCounts();
}

function saveCartToStorage() {
  const cartKey = getCartKey();
  localStorage.setItem(cartKey, JSON.stringify(cart));
  updateCartCounts();
}

function updateCartCounts() {
  const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 0), 0);
  const cartCount = document.getElementById('cart-count');
  const mobileCartCount = document.getElementById('mobile-cart-count');
  
  if (cartCount) cartCount.textContent = totalItems;
  if (mobileCartCount) mobileCartCount.textContent = totalItems;
}

function clearCart() {
  cart = [];
  const cartKey = getCartKey();
  localStorage.removeItem(cartKey);
  console.log('üóëÔ∏è Cart cleared for:', cartKey);
  updateCartCounts();
}

// ============================================
// STEP NAVIGATION
// ============================================
function goToStep(step) {
  if (step === 2 && cart.length === 0) {
    showToast('Your cart is empty!', 'warning');
    return;
  }
  
  if (step === 3) {
    if (!validateStep2()) return;
  }
  
  const currentStepEl = document.getElementById(`step-${currentStep}`);
  const nextStepEl = document.getElementById(`step-${step}`);
  
  if (currentStepEl) currentStepEl.classList.add('hidden');
  if (nextStepEl) nextStepEl.classList.remove('hidden');
  
  for (let i = 1; i <= 3; i++) {
    const indicator = document.getElementById(`step-${i}-indicator`);
    if (!indicator) continue;
    
    if (i < step) {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-complete mb-2 transition-all shadow-lg';
      indicator.innerHTML = '‚úì';
    } else if (i === step) {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg step-active mb-2 transition-all shadow-lg';
      indicator.innerHTML = i;
    } else {
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-gray-200 mb-2 transition-all';
      indicator.innerHTML = i;
    }
  }
  
  currentStep = step;
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep2() {
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const deliveryOptionEl = document.querySelector('input[name="delivery-option"]:checked');
  const deliveryOption = deliveryOptionEl ? deliveryOptionEl.value : 'delivery';
  
  if (!name || !email || !phone) {
    showToast('Please fill in all contact information', 'error');
    return false;
  }
  
  if (deliveryOption === 'delivery') {
    const address = document.getElementById('delivery-address').value.trim();
    if (!address) {
      showToast('Please enter delivery address', 'error');
      return false;
    }
  }
  
  return true;
}

// ============================================
// DELIVERY FIELDS
// ============================================
function toggleDeliveryFields() {
  const deliveryOptionEl = document.querySelector('input[name="delivery-option"]:checked');
  const deliveryOption = deliveryOptionEl ? deliveryOptionEl.value : 'delivery';
  const addressSection = document.getElementById('delivery-address-section');
  
  if (addressSection) {
    if (deliveryOption === 'delivery') {
      addressSection.classList.remove('hidden');
    } else {
      addressSection.classList.add('hidden');
    }
  }
  
  updateTotals();
}

function getCurrentLocation() {
  if (!navigator.geolocation) {
    showToast('Geolocation not supported by your browser', 'error');
    return;
  }

  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<div class="loader"></div> Getting location...';
  button.disabled = true;

  const options = {
    enableHighAccuracy: true,
    timeout: 10000,
    maximumAge: 0
  };

  navigator.geolocation.getCurrentPosition(
    async (position) => {
      userLocation = {
        lat: position.coords.latitude,
        lng: position.coords.longitude,
        accuracy: position.coords.accuracy
      };
      
      console.log('üìç Location detected:', userLocation);
      
      displayLocationOnMap(userLocation);
      await reverseGeocode(userLocation);
      
      button.innerHTML = originalText;
      button.disabled = false;
      
      showToast('Location detected successfully', 'success');
    },
    (error) => {
      console.error('‚ùå Geolocation error:', error);
      let errorMsg = 'Unable to get location. ';
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMsg += 'Please allow location access in your browser settings.';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMsg += 'Location information is unavailable.';
          break;
        case error.TIMEOUT:
          errorMsg += 'Location request timed out.';
          break;
        default:
          errorMsg += 'An unknown error occurred.';
      }
      
      showToast(errorMsg, 'error');
      button.innerHTML = originalText;
      button.disabled = false;
    },
    options
  );
}

function displayLocationOnMap(location) {
  const mapContainer = document.getElementById('location-map-container');
  if (mapContainer) {
    mapContainer.classList.remove('hidden');
  }
  
  if (!locationMap) {
    locationMap = L.map('location-map').setView([location.lat, location.lng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(locationMap);
    
    setTimeout(() => {
      locationMap.invalidateSize();
    }, 100);
  } else {
    locationMap.setView([location.lat, location.lng], 16);
  }
  
  if (locationMarker) {
    locationMarker.setLatLng([location.lat, location.lng]);
  } else {
    const customIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="#cda45e">
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
      `),
      iconSize: [40, 40],
      iconAnchor: [20, 40],
      popupAnchor: [0, -40]
    });
    
    locationMarker = L.marker([location.lat, location.lng], { icon: customIcon })
      .addTo(locationMap)
      .bindPopup('üìç Your Location')
      .openPopup();
  }
  
  const coordsDisplay = document.getElementById('location-coords');
  if (coordsDisplay) {
    coordsDisplay.textContent = `Lat: ${location.lat.toFixed(6)}, Lng: ${location.lng.toFixed(6)} (¬±${Math.round(location.accuracy)}m)`;
  }
}

async function reverseGeocode(location) {
  try {
    console.log('üó∫Ô∏è Reverse geocoding:', location);
    
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?lat=${location.lat}&lon=${location.lng}&format=json&addressdetails=1`,
      {
        headers: {
          'Accept-Language': 'en',
          'User-Agent': 'KusinaKatya/1.0'
        }
      }
    );
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    console.log('‚úÖ Geocode result:', data);
    
    if (data && data.display_name) {
      const addressField = document.getElementById('delivery-address');
      
      let formattedAddress = '';
      const addr = data.address;
      
      if (addr) {
        const parts = [];
        
        if (addr.house_number) parts.push(addr.house_number);
        if (addr.road) parts.push(addr.road);
        
        if (addr.neighbourhood) parts.push(addr.neighbourhood);
        else if (addr.suburb) parts.push(addr.suburb);
        
        if (addr.city) parts.push(addr.city);
        else if (addr.municipality) parts.push(addr.municipality);
        
        if (addr.state) parts.push(addr.state);
        
        if (addr.postcode) parts.push(addr.postcode);
        
        formattedAddress = parts.join(', ');
      }
      
      if (!formattedAddress) {
        formattedAddress = data.display_name;
      }
      
      if (addressField) {
        addressField.value = formattedAddress;
      }
      console.log('üìç Address set:', formattedAddress);
    }
  } catch (error) {
    console.error('‚ùå Geocoding error:', error);
    showToast('Could not fetch address for this location. Please enter manually.', 'warning');
  }
}

// ============================================
// CART DISPLAY
// ============================================
function displayCart() {
  const cartItemsContainer = document.getElementById('cart-items');
  const emptyCartDiv = document.getElementById('empty-cart');
  const continueBtn = document.getElementById('continue-to-details-btn');
  
  if (!cart || cart.length === 0) {
    if (cartItemsContainer) cartItemsContainer.innerHTML = '';
    if (emptyCartDiv) emptyCartDiv.classList.remove('hidden');
    if (continueBtn) continueBtn.classList.add('hidden');
    return;
  }
  
  if (emptyCartDiv) emptyCartDiv.classList.add('hidden');
  if (continueBtn) continueBtn.classList.remove('hidden');
  
  if (cartItemsContainer) {
    cartItemsContainer.innerHTML = cart.map((item, index) => `
      <div class="cart-item flex gap-4 p-4 bg-gradient-to-r from-gray-50 to-cream rounded-xl border-2 border-gray-100 hover:border-accent">
        <div class="w-20 h-20 bg-gradient-to-br from-accent to-accent-dark rounded-lg flex items-center justify-center text-3xl flex-shrink-0 shadow-md overflow-hidden">
          ${item.image ? `<img src="${item.image}" alt="${escapeHtml(item.name)}" class="w-full h-full object-cover">` : 'üç≤'}
        </div>
        <div class="flex-1 min-w-0">
          <h4 class="font-bold text-base mb-1 text-dark">${escapeHtml(item.name)}</h4>
          <p class="text-sm text-accent font-semibold">‚Ç±${item.price.toFixed(2)}</p>
          <div class="flex items-center gap-3 mt-2">
            <button onclick="updateQuantity(${index}, -1)" class="w-8 h-8 bg-gray-200 rounded-full text-base font-bold hover:bg-accent hover:text-white transition-all duration-300">‚àí</button>
            <span class="text-base font-bold w-8 text-center">${item.quantity}</span>
            <button onclick="updateQuantity(${index}, 1)" class="w-8 h-8 bg-gray-200 rounded-full text-base font-bold hover:bg-accent hover:text-white transition-all duration-300">+</button>
          </div>
        </div>
        <div class="text-right flex flex-col justify-between">
          <p class="font-bold text-lg text-accent">‚Ç±${(item.price * item.quantity).toFixed(2)}</p>
          <button onclick="removeItem(${index})" class="text-xs text-red-500 hover:text-red-700 font-semibold transition-colors">Remove</button>
        </div>
      </div>
    `).join('');
  }
  
  updateTotals();
}

function updateQuantity(index, change) {
  if (cart[index]) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
      cart.splice(index, 1);
      showToast('Item removed from cart', 'info');
    }
    
    saveCartToStorage();
    displayCart();
  }
}

function removeItem(index) {
  const itemName = cart[index]?.name || 'Item';
  cart.splice(index, 1);
  
  saveCartToStorage();
  displayCart();
  
  showToast(`${itemName} removed from cart`, 'info');
}

// ============================================
// TOTALS CALCULATION
// ============================================
function updateTotals() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  
  const deliveryOptionEl = document.querySelector('input[name="delivery-option"]:checked');
  const deliveryOption = deliveryOptionEl ? deliveryOptionEl.value : 'delivery';
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  
  let discountedSubtotal = subtotal;
  let finalDelivery = delivery;
  
  if (appliedVoucher) {
    if (appliedVoucher.type === 'shipping') {
      finalDelivery = 0;
    } else {
      discountedSubtotal = subtotal - voucherDiscount;
    }
  }
  
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  
  const subtotalEl = document.getElementById('subtotal');
  const deliveryEl = document.getElementById('delivery-fee');
  const taxEl = document.getElementById('tax');
  const totalEl = document.getElementById('total');
  const discountEl = document.getElementById('voucher-discount');
  
  if (subtotalEl) subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
  if (deliveryEl) deliveryEl.textContent = `‚Ç±${finalDelivery.toFixed(2)}`;
  if (taxEl) taxEl.textContent = `‚Ç±${tax.toFixed(2)}`;
  if (totalEl) totalEl.textContent = `‚Ç±${total.toFixed(2)}`;
  
  if (appliedVoucher && discountEl) {
    discountEl.textContent = `-‚Ç±${voucherDiscount.toFixed(2)}`;
  }
}

function calculateVoucherDiscount(subtotal, deliveryFee) {
  if (!appliedVoucher) return 0;
  
  switch (appliedVoucher.type) {
    case 'percentage':
      return subtotal * (appliedVoucher.value / 100);
    case 'fixed':
      return appliedVoucher.value;
    case 'shipping':
      return deliveryFee;
    default:
      return 0;
  }
}

// ============================================
// VOUCHER MANAGEMENT
// ============================================
async function applyVoucher() {
  const code = document.getElementById('voucher-input').value.trim().toUpperCase();
  const token = getAuthToken();
  
  if (!code) {
    showToast('Please enter voucher code', 'warning');
    return;
  }
  if (!token) {
    showToast('Session expired. Please log in again.', 'error');
    window.location.href = 'login.html';
    return;
  }
  
  try {
    const res = await fetch(`${API_URL}/user/vouchers/validate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        code: code,
        order_total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) + 30
      })
    });
    
    if (res.status === 401) {
      showToast('Session expired. Please log in again.', 'error');
      window.location.href = 'login.html';
      return;
    }
    
    const data = await res.json();
    
    if (data.success) {
      appliedVoucher = {
        id: data.voucher.code,
        code: data.voucher.code,
        type: data.voucher.discount_type,
        value: parseFloat(data.voucher.discount_value)
      };
      
      const appliedVoucherDisplay = document.getElementById('applied-voucher-display');
      const voucherCode = document.getElementById('voucher-code');
      const voucherDiscountRow = document.getElementById('voucher-discount-row');
      
      if (appliedVoucherDisplay) appliedVoucherDisplay.classList.remove('hidden');
      if (voucherCode) voucherCode.textContent = code;
      if (voucherDiscountRow) voucherDiscountRow.classList.remove('hidden');
      
      updateTotals();
      showToast('‚úÖ Voucher applied!', 'success');
    } else {
      showToast(data.message || 'Invalid voucher', 'error');
    }
  } catch (err) {
    console.error('Voucher validation error:', err);
    showToast('Error validating voucher', 'error');
  }
}

function removeVoucher() {
  appliedVoucher = null;
  
  const voucherInput = document.getElementById('voucher-input');
  const appliedVoucherDisplay = document.getElementById('applied-voucher-display');
  const voucherDiscountRow = document.getElementById('voucher-discount-row');
  
  if (voucherInput) voucherInput.value = '';
  if (appliedVoucherDisplay) appliedVoucherDisplay.classList.add('hidden');
  if (voucherDiscountRow) voucherDiscountRow.classList.add('hidden');
  
  updateTotals();
  showToast('Voucher removed', 'info');
}

// ============================================
// PAYMENT FORM
// ============================================
function togglePaymentForm() {
  const paymentMethodEl = document.querySelector('input[name="payment-method"]:checked');
  const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'card';
  const cardForm = document.getElementById('card-payment-form');
  const gcashInfo = document.getElementById('gcash-payment-info');
  
  if (paymentMethod === 'card') {
    if (cardForm) cardForm.classList.remove('hidden');
    if (gcashInfo) gcashInfo.classList.add('hidden');
  } else {
    if (cardForm) cardForm.classList.add('hidden');
    if (gcashInfo) gcashInfo.classList.remove('hidden');
  }
}

function formatCardNumber(input) {
  let value = input.value.replace(/\s/g, '');
  let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
  input.value = formattedValue;
}

function formatExpiry(input) {
  let value = input.value.replace(/\D/g, '');
  if (value.length >= 2) {
    value = value.slice(0, 2) + '/' + value.slice(2, 4);
  }
  input.value = value;
}

function validateCardInputs() {
  const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
  const cardExpiry = document.getElementById('card-expiry').value;
  const cardCvc = document.getElementById('card-cvc').value;
  const cardName = document.getElementById('card-name').value.trim();
  
  if (!cardNumber || !cardExpiry || !cardCvc || !cardName) {
    throw new Error('Please fill in all card details');
  }
  
  if (cardNumber.length < 13 || cardNumber.length > 19) {
    throw new Error('Invalid card number length');
  }
  
  if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
    throw new Error('Invalid expiry format (use MM/YY)');
  }
  
  const [month, year] = cardExpiry.split('/');
  const expMonth = parseInt(month);
  const expYear = parseInt('20' + year);
  
  if (expMonth < 1 || expMonth > 12) {
    throw new Error('Invalid expiry month');
  }
  
  const now = new Date();
  const expDate = new Date(expYear, expMonth - 1);
  if (expDate < now) {
    throw new Error('Card has expired');
  }
  
  if (!/^\d{3}$/.test(cardCvc)) {
    throw new Error('CVC must be 3 digits');
  }
  
  return true;
}

// ============================================
// CHECKOUT PROCESS
// ============================================
async function initiateCheckout() {
  const token = getAuthToken();
  
  if (!token) {
    showToast('Your session has expired. Please log in again.', 'error');
    window.location.href = 'login.html';
    return;
  }
  
  if (cart.length === 0) {
    showToast('Your cart is empty!', 'warning');
    return;
  }
  
  const paymentMethodEl = document.querySelector('input[name="payment-method"]:checked');
  const paymentMethod = paymentMethodEl ? paymentMethodEl.value : 'card';
  const btn = document.getElementById('checkout-btn');
  
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<div class="loader mr-2"></div> Processing...';
  }
  
  try {
    if (paymentMethod === 'card') {
      await processCardPayment(token);
    } else {
      await processGCashPayment(token);
    }
  } catch (error) {
    console.error('Checkout error:', error);
    showToast('Error: ' + error.message, 'error');
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<span>Complete Order</span><span>‚úì</span>';
    }
  }
}

async function processGCashPayment(token) {
  console.log('üì± Processing GCash payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const deliveryOptionEl = document.querySelector('input[name="delivery-option"]:checked');
  const deliveryOption = deliveryOptionEl ? deliveryOptionEl.value : 'delivery';
  const deliveryAddress = deliveryOption === 'delivery' ? document.getElementById('delivery-address').value.trim() : 'Pickup';

  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  
  let discountedSubtotal = subtotal;
  let finalDelivery = delivery;
  
  if (appliedVoucher) {
    if (appliedVoucher.type === 'shipping') {
      finalDelivery = 0;
    } else {
      discountedSubtotal = subtotal - voucherDiscount;
    }
  }
  
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  const amountInCentavos = Math.round(total * 100);

  try {
    const gcashRes = await fetch(`${API_URL}/paymongo/create-gcash-payment`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email }
      })
    });

    const gcashData = await gcashRes.json();

    if (!gcashData.success || !gcashData.checkout_url) {
      throw new Error(gcashData.message || 'GCash payment failed');
    }
    
    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      delivery_address: deliveryAddress,
      delivery_coordinates: userLocation ? `${userLocation.lat},${userLocation.lng}` : null,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'gcash',
      payment_status: 'pending',
      payment_source_id: gcashData.source_id,
      voucher_code: appliedVoucher ? appliedVoucher.code : null,
      voucher_discount: voucherDiscount
    };
    
    const orderResult = await createOrder(token, orderData);
    console.log('‚úÖ Order created:', orderResult.order_id);
    
    if (appliedVoucher) {
      markVoucherAsUsed(appliedVoucher.code);
    }
    
    clearCart();
    localStorage.removeItem('selectedVoucher');
    
    sessionStorage.setItem('pendingGCashOrder', orderResult.order_id);
    
    console.log('üîÑ Redirecting to GCash...');
    window.location.href = gcashData.checkout_url;
    
  } catch (error) {
    console.error('‚ùå GCash payment error:', error);
    throw error;
  }
}

async function processCardPayment(token) {
  console.log('üí≥ Processing card payment...');
  
  const name = document.getElementById('customer-name').value.trim();
  const email = document.getElementById('customer-email').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  
  try {
    validateCardInputs();
  } catch (validationError) {
    throw new Error(validationError.message);
  }
  
  const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
  const cardExpiry = document.getElementById('card-expiry').value;
  const cardCvc = document.getElementById('card-cvc').value;
  const deliveryOptionEl = document.querySelector('input[name="delivery-option"]:checked');
  const deliveryOption = deliveryOptionEl ? deliveryOptionEl.value : 'delivery';
  const deliveryAddress = deliveryOption === 'delivery' ? document.getElementById('delivery-address').value.trim() : 'Pickup';
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const delivery = deliveryOption === 'delivery' ? DELIVERY_FEE : 0;
  const voucherDiscount = calculateVoucherDiscount(subtotal, delivery);
  
  let discountedSubtotal = subtotal;
  let finalDelivery = delivery;
  
  if (appliedVoucher) {
    if (appliedVoucher.type === 'shipping') {
      finalDelivery = 0;
    } else {
      discountedSubtotal = subtotal - voucherDiscount;
    }
  }
  
  const tax = discountedSubtotal * TAX_RATE;
  const total = discountedSubtotal + finalDelivery + tax;
  const amountInCentavos = Math.round(total * 100);

  try {
    const intentResponse = await fetch(`${API_URL}/create-payment-intent`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        amount: amountInCentavos,
        currency: 'PHP',
        customer: { name, email },
        card: {
          number: cardNumber,
          exp_month: parseInt(cardExpiry.split('/')[0]),
          exp_year: parseInt('20' + cardExpiry.split('/')[1]),
          cvc: cardCvc
        }
      })
    });

    if (!intentResponse.ok) {
      const error = await intentResponse.json();
      throw new Error(error.message || 'Payment failed');
    }

    const intentData = await intentResponse.json();
    
    if (intentData.status === 'requires_action') {
      window.location.href = intentData.nextAction.redirect.url;
      return;
    }

    const orderData = {
      customer_name: name,
      customer_email: email,
      customer_phone: phone,
      delivery_address: deliveryAddress,
      delivery_coordinates: userLocation ? `${userLocation.lat},${userLocation.lng}` : null,
      items: cart,
      subtotal: subtotal,
      delivery_fee: finalDelivery,
      tax: tax,
      total: total,
      delivery_option: deliveryOption,
      payment_method: 'card',
      payment_status: intentData.status === 'succeeded' ? 'paid' : 'pending',
      payment_intent_id: intentData.paymentIntentId,
      voucher_code: appliedVoucher ? appliedVoucher.code : null,
      voucher_discount: voucherDiscount
    };

    const result = await createOrder(token, orderData);
    
    if (appliedVoucher) {
      markVoucherAsUsed(appliedVoucher.code);
    }

    clearCart();
    localStorage.removeItem('selectedVoucher');
    
    showSuccessModal(result.order_id);
    
  } catch (error) {
    console.error('‚ùå Card payment error:', error);
    throw error;
  }
}

async function createOrder(token, orderData) {
  const orderResponse = await fetch(`${API_URL}/create-order`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`
    },
    body: JSON.stringify(orderData)
  });

  const result = await orderResponse.json();
  
  if (!orderResponse.ok || !result.success) {
    throw new Error(result.message || 'Failed to create order');
  }
  
  return result;
}

function markVoucherAsUsed(voucherCode) {
  if (!voucherCode) return;
  
  const currentUser = getCurrentUser();
  if (!currentUser) return;
  
  const usedVouchersKey = `usedVouchers_${currentUser.email}`;
  const usedVouchers = JSON.parse(localStorage.getItem(usedVouchersKey) || '[]');
  
  if (!usedVouchers.includes(voucherCode)) {
    usedVouchers.push(voucherCode);
    localStorage.setItem(usedVouchersKey, JSON.stringify(usedVouchers));
    console.log(`‚úÖ Voucher ${voucherCode} marked as used for ${currentUser.email}`);
  }
}

function showSuccessModal(orderId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in';
  modal.innerHTML = `
    <div class="bg-white rounded-3xl p-8 max-w-md mx-4 shadow-2xl text-center animate-scale-in">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>
      </div>
      <h2 class="text-3xl font-bold text-dark mb-2">Order Successful! üéâ</h2>
      <p class="text-gray-600 mb-6">Your order has been placed successfully.</p>
      <div class="bg-gradient-to-br from-accent/10 to-accent-light/10 rounded-lg p-4 mb-6">
        <p class="text-sm text-gray-600 mb-1">Order ID</p>
        <p class="text-2xl font-bold text-accent font-mono">${escapeHtml(orderId)}</p>
      </div>
      ${appliedVoucher ? `<p class="text-sm text-green-600 mb-4 font-semibold">‚úì Voucher ${escapeHtml(appliedVoucher.code)} applied!</p>` : ''}
      <p class="text-sm text-gray-500 mb-4">Redirecting to track your order...</p>
      <a href="orders.html" class="inline-block px-8 py-3 bg-gradient-to-r from-accent to-accent-dark text-white font-bold rounded-full hover:shadow-xl hover:scale-105 transition-all duration-300">
        Track My Order
      </a>
    </div>
  `;
  document.body.appendChild(modal);
  
  setTimeout(() => {
    window.location.href = 'orders.html';
  }, 3000);
}

// ============================================
// VOUCHER PRE-SELECTION
// ============================================
function loadSelectedVoucher() {
  const currentUser = getCurrentUser();
  if (!currentUser) {
    localStorage.removeItem('selectedVoucher');
    return;
  }
  
  const selectedVoucher = localStorage.getItem('selectedVoucher');
  if (selectedVoucher) {
    try {
      appliedVoucher = JSON.parse(selectedVoucher);
      
      const usedVouchersKey = `usedVouchers_${currentUser.email}`;
      const usedVouchers = JSON.parse(localStorage.getItem(usedVouchersKey) || '[]');
      
      if (usedVouchers.includes(appliedVoucher.id)) {
        showToast('This voucher has already been used and cannot be applied again.', 'warning');
        appliedVoucher = null;
        localStorage.removeItem('selectedVoucher');
        return;
      }
      
      const voucherInput = document.getElementById('voucher-input');
      if (voucherInput) voucherInput.value = appliedVoucher.id;
      
      localStorage.removeItem('selectedVoucher');
      
      const appliedVoucherDisplay = document.getElementById('applied-voucher-display');
      const voucherCode = document.getElementById('voucher-code');
      const voucherDiscountRow = document.getElementById('voucher-discount-row');
      
      if (appliedVoucherDisplay) appliedVoucherDisplay.classList.remove('hidden');
      if (voucherCode) voucherCode.textContent = appliedVoucher.id;
      if (voucherDiscountRow) voucherDiscountRow.classList.remove('hidden');
      
      updateTotals();
      showToast('Voucher pre-applied from profile', 'success');
    } catch (e) {
      console.error('Error loading selected voucher:', e);
      localStorage.removeItem('selectedVoucher');
    }
  }
}

// ============================================
// USER INFO AUTO-FILL
// ============================================
function loadUserInfo() {
  const user = getCurrentUser();
  
  if (!user) {
    console.warn('‚ö†Ô∏è No user data available');
    return;
  }
  
  const nameField = document.getElementById('customer-name');
  const emailField = document.getElementById('customer-email');
  const phoneField = document.getElementById('customer-phone');
  
  if (user.name && nameField) nameField.value = user.name;
  if (user.email && emailField) emailField.value = user.email;
  if (user.phone && phoneField) phoneField.value = user.phone;
  
  console.log('‚úÖ User info loaded into form');
}

// ============================================
// PAGE INITIALIZATION
// ============================================
window.addEventListener('DOMContentLoaded', () => {
  console.log('üöÄ Cart page loading...');
  
  if (!isUserAuthenticated()) {
    console.warn('‚ùå Not authenticated, redirecting to login');
    showToast('Please log in to view your cart', 'warning');
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 1500);
    return;
  }
  
  const user = getCurrentUser();
  console.log('‚úÖ User authenticated:', user.email);
  
  updateUIForAuthenticatedUser();
  loadCartFromStorage();
  loadSelectedVoucher();
  loadUserInfo();
  displayCart();
  toggleDeliveryFields();
  initializeSocket();
  
  updateCartCounts();
  
  console.log('‚úÖ Cart page initialized');
});

// ============================================
// CLEANUP
// ============================================
window.addEventListener('beforeunload', () => {
  if (socket && socket.connected) {
    socket.disconnect();
  }
  
  if (locationMap) {
    locationMap.remove();
    locationMap = null;
  }
  
  if (locationMarker) {
    locationMarker = null;
  }
});

// ============================================
// DEBUG HELPERS (Development Only)
// ============================================
if (window.location.hostname === 'localhost') {
  window.debugCart = {
    viewCart: () => console.log('Cart:', cart),
    viewUser: () => console.log('User:', getCurrentUser()),
    viewToken: () => console.log('Token:', getAuthToken()),
    viewVoucher: () => console.log('Voucher:', appliedVoucher),
    clearAll: () => {
      clearCart();
      localStorage.clear();
      sessionStorage.clear();
      console.log('‚úÖ All storage cleared');
    }
  };
  console.log('üõ†Ô∏è Debug helpers available: window.debugCart');
}

console.log('‚úÖ Cart page script loaded');
</script>

</body>
</html>