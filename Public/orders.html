<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>My Orders - Kusina ni Katya</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="/socket.io/socket.io.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          accent: '#cda45e',
          'accent-light': '#e5b66a',
          'accent-dark': '#b8924e',
          dark: '#1a1a1a',
          'dark-light': '#2d2d2d',
          'light-bg': '#fef9f3',
          'cream': '#f5e9da',
        },
        fontFamily: {
          Inter: ['Inter', 'sans-serif'],
        }
      }
    }
  }
</script>

<style>
  @font-face {
    font-family: 'Quiapo';
    src: url('assets/fonts/Quiapo_Free.ttf') format('opentype');
  }
  body { font-family: 'Inter', sans-serif; }
  .font-quiapo { font-family: 'Quiapo', 'Inter', sans-serif; }
  .glass-effect { backdrop-filter: blur(10px); }
  .pattern-bg {
    background-color: #fef3f3;
    background-image:
      radial-gradient(circle at 25% 25%, rgba(205, 164, 94, 0.03) 0%, transparent 50%),
      radial-gradient(circle at 75% 75%, rgba(205, 164, 94, 0.03) 0%, transparent 50%);
  }
  .order-card { 
    transition: all 0.3s ease;
    animation: slideIn 0.3s ease-out;
  }
  .order-card:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 12px 24px rgba(205, 164, 94, 0.15); 
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  #tracking-map {
    height: 500px;
    width: 100%;
    border-radius: 16px;
    z-index: 1;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .leaflet-container { z-index: 1 !important; }

  @keyframes riderPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  .rider-marker { animation: riderPulse 2s ease-in-out infinite; }

  .timeline-item {
    position: relative;
    padding-left: 45px;
    padding-bottom: 28px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 40px;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #cda45e, #e5e7eb);
  }
  .timeline-item:last-child::before { display: none; }
  .timeline-item:last-child { padding-bottom: 0; }
  .timeline-dot {
    position: absolute;
    left: 0;
    top: 8px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 4px solid #e5e7eb;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 2;
  }
  .timeline-dot.active {
    background: #cda45e;
    border-color: #cda45e;
    box-shadow: 0 0 0 6px rgba(205, 164, 94, 0.2);
    animation: pulse-ring 2s ease-in-out infinite;
  }
  .timeline-dot.completed {
    background: #10b981;
    border-color: #10b981;
    color: white;
  }
  .timeline-dot.completed::after {
    content: '‚úì';
    color: white;
    font-size: 16px;
    font-weight: bold;
  }
  @keyframes pulse-ring {
    0% { box-shadow: 0 0 0 0 rgba(205, 164, 94, 0.4); }
    50% { box-shadow: 0 0 0 15px rgba(205, 164, 94, 0); }
    100% { box-shadow: 0 0 0 0 rgba(205, 164, 94, 0); }
  }

  .route-line {
    stroke-dasharray: 10, 5;
    animation: dash 20s linear infinite;
  }
  @keyframes dash {
    to { stroke-dashoffset: -100; }
  }

  .eta-badge { animation: float 3s ease-in-out infinite; }
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-5px); }
  }

  /* PROGRESS BAR STYLES */
  .tracking-progress-container {
    position: relative;
    width: 100%;
    height: 10px;
    background: #e5e7eb;
    border-radius: 999px;
    overflow: hidden;
    margin: 16px 0;
  }

  .tracking-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #cda45e 0%, #e5b66a 100%);
    border-radius: 999px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(205, 164, 94, 0.3);
    position: relative;
    width: 0%;
  }

  .tracking-progress-bar::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
  }

  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .tracking-status-label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .tracking-message-box {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #3b82f6;
    padding: 14px 18px;
    border-radius: 10px;
    margin: 16px 0;
    animation: messageSlide 0.4s ease-out;
  }

  @keyframes messageSlide {
    from { opacity: 0; transform: translateX(-10px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    animation: slideInRight 0.3s ease-out;
  }
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
</style>
</head>
<body class="bg-light-bg pattern-bg text-dark overflow-x-hidden">

<!-- HEADER -->
<header class="sticky top-0 z-50 glass-effect bg-white/80 shadow-md transition-all duration-300">
  <nav class="max-w-full mx-auto px-4 sm:px-6 lg:px-12">
    <div class="flex justify-between items-center h-16 sm:h-20">
      <div class="flex items-center space-x-2 sm:space-x-3 flex-shrink-0">
        <a href="index.html" class="flex items-center space-x-2 sm:space-x-3">
          <img src="assets/images/logo1.png" alt="Logo" class="w-10 h-10 sm:w-14 sm:h-14 object-contain rounded-full shadow-lg" />
        </a>
        <div class="hidden sm:block">
          <h1 class="font-quiapo text-xl sm:text-2xl font-bold text-accent tracking-widest">Kusina ni Katya</h1>
          <p class="text-xs text-gray-600">Authentic Filipino Cuisine</p>
        </div>
      </div>
      
      <div class="hidden lg:flex items-center space-x-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Menu</a>
        <a href="orders.html" class="text-accent font-medium transition-colors text-[15px]">Orders</a>
        <a href="contacts.html" class="text-dark-light hover:text-accent font-medium transition-colors text-[15px]">Contact</a>
        <a href="cart.html" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg hover:scale-105 transition-all text-[13px]">
          üõí View Cart (<span id="cart-count">0</span>)
        </a>
        
        <div id="auth-buttons" class="flex items-center gap-2">
          <a href="login.html" class="px-5 py-2.5 bg-white border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white transition-all text-[13px]">Log In</a>
          <a href="signup.html" class="px-5 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-lg transition-all text-[13px]">Sign Up</a>
        </div>
        
        <div id="user-profile" class="hidden items-center gap-2">
          <a href="profile.html" class="flex items-center space-x-2 px-3 py-2 bg-accent/10 rounded-full hover:bg-accent/20 transition-all cursor-pointer">
            <div class="w-8 h-8 bg-accent rounded-full flex items-center justify-center">
              <span id="user-initial" class="text-white font-bold text-xs">U</span>
            </div>
            <span id="user-name" class="text-dark font-semibold text-[13px]">User</span>
          </a>
          <button onclick="logout()" class="px-5 py-2.5 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition-all text-[13px]">Logout</button>
        </div>
      </div>
      
      <button onclick="toggleMobileMenu()" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 flex-shrink-0">
        <svg class="w-6 h-6 text-dark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    
    <div id="mobile-menu" class="hidden lg:hidden pb-6">
      <div class="flex flex-col space-y-3">
        <a href="index.html" class="text-dark-light hover:text-accent font-medium py-2">Home</a>
        <a href="menu.html" class="text-dark-light hover:text-accent font-medium py-2">Menu</a>
        <a href="orders.html" class="text-accent font-medium py-2">Orders</a>
        <a href="cart.html" class="text-dark-light hover:text-accent font-medium py-2">üõí Cart (<span id="mobile-cart-count">0</span>)</a>
        
        <div id="mobile-auth-buttons" class="flex flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="login.html" class="px-6 py-2.5 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full text-center">Log In</a>
          <a href="signup.html" class="px-6 py-2.5 border-2 border-accent text-accent font-semibold rounded-full hover:bg-accent hover:text-white text-center">Sign Up</a>
        </div>
        
        <div id="mobile-user-profile" class="hidden flex-col space-y-3 pt-3 border-t border-gray-200">
          <a href="profile.html" class="flex items-center space-x-3 px-4 py-2 bg-accent/10 rounded-full">
            <div class="w-10 h-10 bg-accent rounded-full flex items-center justify-center">
              <span id="mobile-user-initial" class="text-white font-bold">U</span>
            </div>
            <span id="mobile-user-name" class="text-dark font-semibold">User</span>
          </a>
          <button onclick="logout()" class="px-6 py-2.5 bg-red-500 text-white font-semibold rounded-full text-center">Logout</button>
        </div>
      </div>
    </div>
  </nav>
</header>

<!-- HERO -->
<section class="py-8 px-4 sm:px-6 lg:px-8 bg-gradient-to-br from-cream/30 to-accent-light/10">
  <div class="max-w-7xl mx-auto">
    <h1 class="font-quiapo text-4xl md:text-5xl font-bold text-dark mb-2">
       <span class="text-accent">My Orders</span>
    </h1>
    <div class="w-24 h-1 bg-gradient-to-r from-accent-dark via-accent to-accent-light rounded-full mb-3"></div>
    <p class="text-gray-600 text-base md:text-lg">Track and manage all your orders in real-time</p>
  </div>
</section>

<!-- CONTENT -->
<section class="py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    
    <!-- Filters -->
    <div class="mb-6 flex flex-wrap gap-3 bg-white rounded-2xl p-4 shadow-md">
      <button onclick="filterOrders('all')" id="filter-all" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gradient-to-r from-accent to-accent-dark text-white transition-all">All Orders</button>
      <button onclick="filterOrders('paid')" id="filter-paid" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Paid</button>
      <button onclick="filterOrders('pending')" id="filter-pending" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Pending</button>
      <button onclick="filterOrders('failed')" id="filter-failed" class="filter-btn px-6 py-2.5 rounded-full font-semibold bg-gray-100 text-dark hover:bg-accent hover:text-white transition-all">Failed</button>
    </div>

    <!-- Loading Skeleton -->
    <div id="loading-skeleton" class="grid grid-cols-1 gap-6 hidden">
      <div class="bg-white rounded-xl p-6 shadow-md">
        <div class="skeleton h-6 w-32 rounded mb-3"></div>
        <div class="skeleton h-4 w-full rounded mb-2"></div>
        <div class="skeleton h-4 w-3/4 rounded mb-4"></div>
        <div class="flex justify-between">
          <div class="skeleton h-8 w-24 rounded"></div>
          <div class="skeleton h-10 w-32 rounded"></div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loading-orders" class="flex justify-center items-center py-16 hidden">
      <div class="text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-accent mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">Loading your orders...</p>
      </div>
    </div>

    <!-- Orders Container -->
    <div id="orders-container" class="grid grid-cols-1 gap-6 hidden"></div>

    <!-- Empty State -->
    <div id="empty-orders" class="hidden text-center py-16">
      <div class="bg-white rounded-3xl p-12 shadow-lg max-w-md mx-auto">
        <svg class="w-24 h-24 mx-auto mb-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
        </svg>
        <h3 class="text-2xl font-bold text-dark mb-3">No orders yet</h3>
        <p class="text-gray-600 mb-6">Start ordering delicious Filipino dishes!</p>
        <button onclick="browseMenuGuard()" class="inline-block px-8 py-3 bg-gradient-to-r from-accent to-accent-dark text-white font-semibold rounded-full hover:shadow-xl hover:scale-105 transition-all">Browse Menu ‚Üí</button>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden">
      <div class="bg-white rounded-xl p-8 text-center shadow max-w-md mx-auto">
        <svg class="w-16 h-16 text-red-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <p class="text-gray-500 text-lg mb-4">Failed to load orders</p>
        <p id="error-message" class="text-sm text-gray-400 mb-4"></p>
        <button onclick="loadOrders(true)" class="px-6 py-3 bg-accent text-white font-semibold rounded-xl hover:bg-accent-dark transition-all">Retry</button>
      </div>
    </div>
  </div>
</section>

<!-- FOOTER -->
<footer class="bg-dark text-white py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-7xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
      <!-- Brand -->
      <div class="col-span-1 md:col-span-2">
        <h3 class="font-quiapo text-3xl font-bold text-accent mb-3">Kusina ni Katya</h3>
        <p class="text-gray-400 mb-4">Bringing authentic Filipino home cooking to your table since 2020.</p>
        <div class="flex space-x-4">
          <a href="#" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-accent transition-colors duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
          </a>
          <a href="#" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-accent transition-colors duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
          </a>
          <a href="#" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-accent transition-colors duration-300">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>
          </a>
        </div>
      </div>

      <!-- Quick Links -->
      <div>
        <h4 class="font-bold text-lg mb-4">Quick Links</h4>
        <ul class="space-y-2 text-gray-400">
          <li><a href="#featured" class="hover:text-accent transition-colors duration-300">Menu</a></li>
          <li><a href="#specials" class="hover:text-accent transition-colors duration-300">Specials</a></li>
          <li><a href="#contact" class="hover:text-accent transition-colors duration-300">Contact</a></li>
          <li><a href="#" class="hover:text-accent transition-colors duration-300">About Us</a></li>
        </ul>
      </div>

      <!-- Legal -->
      <div>
        <h4 class="font-bold text-lg mb-4">Legal</h4>
        <ul class="space-y-2 text-gray-400">
          <li><a href="#" class="hover:text-accent transition-colors duration-300">Privacy Policy</a></li>
          <li><a href="#" class="hover:text-accent transition-colors duration-300">Terms of Service</a></li>
          <li><a href="#" class="hover:text-accent transition-colors duration-300">Cookie Policy</a></li>
          <li><a href="#" class="hover:text-accent transition-colors duration-300">Refund Policy</a></li>
        </ul>
      </div>
    </div>

    <div class="border-t border-white/10 pt-8 text-center text-gray-400">
      <p>&copy; 2025 Kusina ni Katya. All Rights Reserved.</p>
    </div>
  </div>
</footer>

<!-- Toast Container -->
<div id="toast-container"></div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const API_URL = '/api';
const SILENT_REFRESH_MS = 10000;
const RESTAURANT_LOCATION = [14.6091, 121.0223];

// ============================================
// STATUS MAPPING FOR PROGRESS BAR
// ============================================
const progressSteps = {
  placed: 25,
  preparing: 50,
  delivering: 75,
  delivered: 100,
  cancelled: 0
};

// Status messages
function getStatusMessage(status) {
  const messages = {
    placed: 'üì¶ Your order has been placed and confirmed!',
    preparing: 'üë®‚Äçüç≥ Our chefs are preparing your delicious meal!',
    delivering: 'üöö Your order is on the way! Rider en route.',
    delivered: '‚úÖ Your order has been delivered! Enjoy your meal!',
    cancelled: '‚ùå This order was cancelled.'
  };
  return messages[status] || `Order status: ${status}`;
}

// ============================================
// STORE HOURS
// ============================================
function isStoreOpen() {
  const now = new Date();
  const hours = now.getHours();
  const day = now.getDay();
  // Open Monday (1) to Saturday (6), 11:00 - 15:00
    return day >= 1 && day <= 6 && hours >= 11 && hours < 15;
}

// Status colors
function getStatusColor(status) {
  const colors = {
    placed: 'bg-blue-100 text-blue-700',
    preparing: 'bg-yellow-100 text-yellow-700',
    delivering: 'bg-orange-100 text-orange-700',
    delivered: 'bg-green-100 text-green-700',
    cancelled: 'bg-red-100 text-red-700'
  };
  return colors[status] || 'bg-gray-100 text-gray-700';
}

// ============================================
// GLOBAL STATE
// ============================================
let allOrders = [];
let currentFilter = 'all';
let socket = null; // Socket.IO instance
let trackingMap = null;
let restaurantMarker = null;
let customerMarker = null;
let riderMarker = null;
let routeLine = null;
let trackingOrderId = null;
let trackingInterval = null;
let riderSimulationInterval = null;
let currentRiderIndex = 0;
let routePoints = [];
let refreshTimer = null;
let socketEventListenersAdded = false;

// ============================================
// AUTH UTILITIES
// ============================================
function getCurrentUser() {
  try {
    const str = localStorage.getItem('currentUser');
    if (!str || str === 'null' || str === 'undefined') return null;
    const user = JSON.parse(str);
    return (user && user.email) ? user : null;
  } catch (err) {
    console.error('Error parsing currentUser:', err);
    return null;
  }
}

function getAuthToken() {
  try {
    return sessionStorage.getItem('authToken') || 
           localStorage.getItem('authToken') || 
           localStorage.getItem('adminToken') || 
           null;
  } catch (err) {
    console.error('Error getting auth token:', err);
    return null;
  }
}

function getClientKey() {
  try {
    let key = localStorage.getItem('clientKey');
    if (!key || key === 'null' || key === 'undefined') {
      // Generate RFC4122-ish v4
      const tpl = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
      key = tpl.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
      localStorage.setItem('clientKey', key);
    }
    return key;
  } catch (e) {
    return 'anon-client';
  }
}

function isUserAuthenticated() {
  const user = getCurrentUser();
  const token = getAuthToken();
  return !!(user && user.email && token);
}

function redirectToLogin() {
  showToast('Please log in to view your orders.', 'info');
  window.location.href = 'login.html';
}

function updateUIForUser() {
  const user = getCurrentUser();
  if (!user) return;

  const authButtons = document.getElementById('auth-buttons');
  const userProfile = document.getElementById('user-profile');
  const mobileAuth = document.getElementById('mobile-auth-buttons');
  const mobileUser = document.getElementById('mobile-user-profile');

  if (authButtons) authButtons.classList.add('hidden');
  if (userProfile) {
    userProfile.classList.remove('hidden');
    userProfile.classList.add('flex');
  }
  if (mobileAuth) mobileAuth.classList.add('hidden');
  if (mobileUser) {
    mobileUser.classList.remove('hidden');
    mobileUser.classList.add('flex');
  }

  const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
  const userName = user.name || 'User';

  const elements = [
    { id: 'user-initial', value: initial },
    { id: 'user-name', value: userName },
    { id: 'mobile-user-initial', value: initial },
    { id: 'mobile-user-name', value: userName }
  ];

  elements.forEach(el => {
    const elem = document.getElementById(el.id);
    if (elem) elem.textContent = el.value;
  });
}

function getCartKey() {
  try {
    const userStr = localStorage.getItem('currentUser');
    if (!userStr || userStr === 'null' || userStr === 'undefined') {
      return 'kusinaCart_guest';
    }
    const user = JSON.parse(userStr);
    return (user && user.email) ? `kusinaCart_${user.email}` : 'kusinaCart_guest';
  } catch (e) {
    return 'kusinaCart_guest';
  }
}

function loadCartCount() {
  try {
    const cartKey = getCartKey();
    const saved = localStorage.getItem(cartKey);
    const cartItems = saved ? JSON.parse(saved) : [];
    const totalItems = Array.isArray(cartItems) 
      ? cartItems.reduce((sum, item) => sum + (item.quantity || 0), 0) 
      : 0;
    
    const desktop = document.getElementById('cart-count');
    const mobile = document.getElementById('mobile-cart-count');
    
    if (desktop) desktop.textContent = totalItems;
    if (mobile) mobile.textContent = totalItems;
  } catch (e) {
    console.error('Error loading cart count:', e);
  }
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    try {
      localStorage.removeItem('currentUser');
      sessionStorage.removeItem('authToken');
      localStorage.removeItem('authToken');
      localStorage.removeItem('adminToken');
      window.location.href = 'login.html';
    } catch (err) {
      console.error('Logout error:', err);
      window.location.href = 'login.html';
    }
  }
}

function toggleMobileMenu() {
  const menu = document.getElementById('mobile-menu');
  if (menu) menu.classList.toggle('hidden');
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const colors = {
    success: 'border-l-4 border-green-500',
    error: 'border-l-4 border-red-500',
    info: 'border-l-4 border-blue-500',
    warning: 'border-l-4 border-yellow-500'
  };

  const toast = document.createElement('div');
  toast.className = `toast ${colors[type] || colors.info} mb-4`;
  toast.innerHTML = `
    <div class="flex items-center gap-3">
      <div class="flex-1">
        <p class="text-sm font-semibold text-dark">${escapeHtml(message)}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
  `;

  container.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 5000);
}

function browseMenuGuard() {
  if (!isStoreOpen()) {
    showToast("We're closed right now. Please come back during opening hours.", 'info');
    return;
  }
  window.location.href = 'menu.html';
}

// ============================================
// API CALLS
// ============================================
async function fetchOrdersFromServer() {
  const token = getAuthToken();
  if (!token) {
    console.error('No authentication token available');
    return { success: false, message: 'No authentication token' };
  }

  try {
    console.log('üì° Fetching orders from:', `${API_URL}/orders`);

    const response = await fetch(`${API_URL}/orders`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    console.log('üì° Response status:', response.status);

    if (!response.ok) {
      const text = await response.text();
      console.error('‚ùå Response error:', text);
      return { 
        success: false, 
        message: text || `HTTP ${response.status}`,
        status: response.status
      };
    }

    const data = await response.json();
    console.log('‚úÖ Orders fetched:', data.length || 0, 'orders');
    
    return { success: true, data: Array.isArray(data) ? data : [] };
  } catch (error) {
    console.error('‚ùå Fetch orders error:', error);
    return { success: false, message: error.message || 'Network error' };
  }
}

// ============================================
// ORDERS LOADING & DISPLAY
// ============================================
async function loadOrders(showLoading = true) {
  const container = document.getElementById('orders-container');
  const loadingDiv = document.getElementById('loading-orders');
  const skeletonDiv = document.getElementById('loading-skeleton');
  const emptyDiv = document.getElementById('empty-orders');
  const errorDiv = document.getElementById('error-state');

  if (!isUserAuthenticated()) {
    hideAllContainers();
    redirectToLogin();
    return;
  }

  hideAllContainers();

  if (showLoading) {
    if (allOrders.length === 0) {
      skeletonDiv.classList.remove('hidden');
    } else {
      loadingDiv.classList.remove('hidden');
    }
  }

  const result = await fetchOrdersFromServer();

  hideAllContainers();

  if (!result.success) {
    if (result.status === 401) {
      redirectToLogin();
      return;
    }

    errorDiv.classList.remove('hidden');
    const errorMsg = document.getElementById('error-message');
    if (errorMsg) errorMsg.textContent = result.message || 'Unknown error';
    return;
  }

  const newOrders = result.data;

  if (!newOrders || newOrders.length === 0) {
    emptyDiv.classList.remove('hidden');
    allOrders = [];
    return;
  }

  container.classList.remove('hidden');

  const changed = haveOrdersChanged(allOrders, newOrders);
  if (changed) {
    allOrders = newOrders;
    filterOrders(currentFilter);
  }
}

function haveOrdersChanged(oldList, newList) {
  if (!Array.isArray(oldList) || !Array.isArray(newList)) return true;
  if (oldList.length !== newList.length) return true;

  for (let i = 0; i < newList.length; i++) {
    const newOrder = newList[i];
    const oldOrder = oldList[i];
    
    if (!oldOrder) return true;
    
    const newId = newOrder.order_id || newOrder.id;
    const oldId = oldOrder.order_id || oldOrder.id;
    
    if (newId !== oldId) return true;
    if (newOrder.delivery_status !== oldOrder.delivery_status) return true;
    if (newOrder.payment_status !== oldOrder.payment_status) return true;
  }

  return false;
}

function displayOrders(orders) {
  const container = document.getElementById('orders-container');
  if (!container) return;

  if (!orders || orders.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-8">No orders found</p>';
    return;
  }

  container.innerHTML = orders.map(order => {
    const orderId = order.order_id || order.id || 'N/A';
    const dateValue = order.created_at || order.createdAt || new Date().toISOString();
    const orderDate = formatDate(dateValue);
    
    const paymentStatus = order.payment_status || order.paymentStatus || 'pending';
    const deliveryStatus = order.delivery_status || order.deliveryStatus || 'placed';
    
    const { color: statusColor, text: statusText } = getStatusDisplay(paymentStatus);
    
    const items = parseOrderItems(order.items);
    const itemNames = items.map(i => escapeHtml(i.name || 'Item')).join(', ') || 'No items';
    
    const total = parseFloat(order.total || 0).toFixed(2);

    return `
      <div class="bg-white rounded-xl p-6 shadow-md order-card" data-order-id="${orderId}">
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="text-lg font-bold text-dark">#${escapeHtml(orderId)}</h3>
            <p class="text-sm text-gray-500">${orderDate}</p>
            <p class="text-xs text-gray-400 mt-1">Status: ${escapeHtml(deliveryStatus)}</p>
          </div>
          <span class="px-3 py-1 ${statusColor} rounded-full text-xs font-semibold">${statusText}</span>
        </div>
        <p class="text-gray-600 text-sm mb-3 line-clamp-2">${itemNames}</p>
        <div class="flex justify-between items-center pt-3 border-t border-gray-100">
          <span class="text-lg font-bold text-accent">‚Ç±${total}</span>
          <button onclick="startTracking('${orderId}')" class="px-4 py-2 bg-gradient-to-r from-accent to-accent-dark text-white text-sm font-semibold rounded-lg hover:shadow-lg transition-all">
            üö¥ Track Order
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function parseOrderItems(items) {
  if (!items) return [];
  if (Array.isArray(items)) return items;
  
  try {
    const parsed = JSON.parse(items);
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      month: 'long', 
      day: 'numeric', 
      year: 'numeric' 
    });
  } catch {
    return 'Unknown date';
  }
}

function getStatusDisplay(status) {
  const statusLower = (status || 'pending').toLowerCase();
  
  const statusMap = {
    'paid': { color: 'bg-green-100 text-green-700', text: 'Paid' },
    'pending': { color: 'bg-yellow-100 text-yellow-700', text: 'Pending' },
    'failed': { color: 'bg-red-100 text-red-700', text: 'Failed' },
    'cancelled': { color: 'bg-gray-100 text-gray-700', text: 'Cancelled' }
  };

  return statusMap[statusLower] || statusMap.pending;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function hideAllContainers() {
  const containers = ['loading-orders', 'loading-skeleton', 'orders-container', 'empty-orders', 'error-state'];
  containers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
}

// ============================================
// FILTERING
// ============================================
function filterOrders(status) {
  currentFilter = status;

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.remove('bg-gradient-to-r', 'from-accent', 'to-accent-dark', 'text-white');
    btn.classList.add('bg-gray-100', 'text-dark');
  });

  const activeBtn = document.getElementById(`filter-${status}`);
  if (activeBtn) {
    activeBtn.classList.remove('bg-gray-100', 'text-dark');
    activeBtn.classList.add('bg-gradient-to-r', 'from-accent', 'to-accent-dark', 'text-white');
  }

  if (status === 'all') {
    displayOrders(allOrders);
  } else {
    const filtered = allOrders.filter(order => {
      const paymentStatus = (order.payment_status || order.paymentStatus || '').toLowerCase();
      return paymentStatus === status.toLowerCase();
    });
    displayOrders(filtered);
  }
}

// ============================================
// SOCKET.IO INITIALIZATION
// ============================================

/**
 * Initialize Socket.IO connection for real-time order updates
 * Connects to backend and joins user-specific room
 */
function initializeSocket() {
  // Reuse a single socket instance across any accidental re-inits on this page
  if (window.__ordersSocket && window.__ordersSocket.connected) {
    socket = window.__ordersSocket;
    console.log('‚úÖ Reusing existing orders socket:', socket.id);
    return;
  }
  if (socket && socket.connected) {
    console.log('‚úÖ Socket already connected');
    window.__ordersSocket = socket;
    return;
  }

  const token = getAuthToken();
  const user = getCurrentUser();
  
  if (!token || !user) {
    console.log('‚ö†Ô∏è No auth token or user for socket connection');
    return;
  }

  try {
    socket = io(window.location.origin, {
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      transports: ['websocket', 'polling'],
      auth: { token: token, clientKey: getClientKey() }
    });
    window.__ordersSocket = socket;

    socket.on('connect', () => {
      console.log('üîå Socket connected:', socket.id);
      
      // Join user-specific room to receive order updates
      if (user && user.id) {
        socket.emit('join-user', { userId: user.id });
        console.log(`‚úÖ Joined room: user-${user.id}`);
      }
    });

    socket.on('disconnect', (reason) => {
      console.log('‚ùå Socket disconnected:', reason);
    });

    socket.on('connect_error', (error) => {
      console.error('‚ùå Socket connection error:', error);
    });

    // Register event listeners only once
    if (!socketEventListenersAdded) {
      // MAIN EVENT: Listen for order status changes from admin
      socket.on('order-status-changed', handleOrderStatusChanged);
      
      socket.on('order-updated', handleOrderUpdate);
      socket.on('orderUpdated', handleOrderUpdate);
      socket.on('location-update', handleLocationUpdate);
      socket.on('new-order', handleNewOrder);
      
      socket.on('tracking-started', (data) => {
        console.log('‚úÖ Tracking started:', data);
      });
      
      socketEventListenersAdded = true;
      console.log('‚úÖ Socket event listeners registered');
    }

  } catch (error) {
    console.error('‚ùå Socket initialization error:', error);
  }
}

// ============================================
// SOCKET.IO EVENT HANDLERS
// ============================================

/**
 * KEY FUNCTION: Handle real-time order status changes from admin
 * This function receives updates when admin changes delivery status
 * Updates both orders list and tracking modal with animations
 */
function handleOrderStatusChanged(payload) {
  if (!payload) return;
  
  const orderId = payload.orderId || payload.order_id || payload.id;
  const status = payload.status || payload.delivery_status;
  const timestamp = payload.timestamp || new Date().toISOString();
  
  console.log(`üì¶ Order status changed (Socket.IO): ${orderId} ‚Üí ${status}`);

  if (!orderId) return;

  // Update order in local array
  const index = allOrders.findIndex(o => {
    const id = o.order_id || o.id;
    return id && String(id) === String(orderId);
  });

  if (index !== -1) {
    allOrders[index].delivery_status = status;
    filterOrders(currentFilter); // Re-render orders list
  }

  // Update tracking modal if it's currently open for this order
  if (trackingOrderId && String(trackingOrderId) === String(orderId)) {
    updateTrackingModalRealtime(orderId, status, timestamp);
  }

  // Show toast notification
  const statusText = status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Updated';
  showToast(`Order #${orderId}: ${statusText}`, 'success');
}

/**
 * Update tracking modal with real-time status changes and animations
 * Animates progress bar, updates message, and refreshes timeline
 */
function updateTrackingModalRealtime(orderId, status, timestamp) {
  if (!status) return;

  const modal = document.getElementById('tracking-modal');
  if (!modal) return;

  console.log(`üé® Updating modal in real-time: ${orderId} ‚Üí ${status}`);

  // 1. Update or create progress bar
  let progressBar = modal.querySelector('.tracking-progress-bar');
  if (!progressBar) {
    const mapContainer = modal.querySelector('#tracking-map');
    if (mapContainer) {
      const progressHTML = `
        <div class="tracking-progress-container">
          <div class="tracking-progress-bar" style="width: 0%"></div>
        </div>
      `;
      mapContainer.insertAdjacentHTML('afterend', progressHTML);
      progressBar = modal.querySelector('.tracking-progress-bar');
    }
  }
  
  // Animate progress bar to new width
  if (progressBar) {
    const targetWidth = progressSteps[status] || 0;
    progressBar.style.width = `${targetWidth}%`;
    console.log(`üìä Progress bar animated to ${targetWidth}%`);
  }

  // 2. Update or create message box
  let messageBox = modal.querySelector('.tracking-message-box');
  if (!messageBox) {
    const timeline = modal.querySelector('#order-timeline');
    if (timeline?.parentNode) {
      messageBox = document.createElement('div');
      messageBox.className = 'tracking-message-box';
      timeline.parentNode.insertBefore(messageBox, timeline);
    }
  }
  
  if (messageBox) {
    messageBox.innerHTML = `
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <div class="flex-1">
          <p class="text-sm font-semibold text-dark">${getStatusMessage(status)}</p>
          <p class="text-xs text-gray-500 mt-1">Updated: ${formatDateTime(timestamp)}</p>
        </div>
      </div>
    `;
    
    // Trigger animation
    messageBox.style.animation = 'none';
    setTimeout(() => {
      messageBox.style.animation = '';
    }, 10);
  }

  // 3. Update timeline stages
  updateTimelineForStatus(status);

  // 4. Update ETA display
  const etas = {
    placed: '20-30 mins',
    preparing: '15-20 mins',
    delivering: '5-10 mins',
    delivered: 'Delivered!',
    cancelled: 'Cancelled'
  };
  const etaEl = document.getElementById('eta-display');
  if (etaEl) etaEl.textContent = etas[status] || 'Calculating...';

  // 5. Stop simulation if delivered
  if (status === 'delivered') {
    stopRiderSimulation();
  }
}

/**
 * Update timeline dots based on delivery status
 */
function updateTimelineForStatus(status) {
  const statusLower = (status || '').toLowerCase();
  
  // Always mark order as placed
  updateTimelineStatus('order-placed', 'completed');
  
  if (statusLower === 'placed') {
    updateTimelineStatus('preparing', 'pending');
    updateTimelineStatus('on-the-way', 'pending');
    updateTimelineStatus('delivered', 'pending');
  } else if (statusLower === 'preparing') {
    updateTimelineStatus('preparing', 'active');
    updateTimelineStatus('on-the-way', 'pending');
    updateTimelineStatus('delivered', 'pending');
  } else if (statusLower === 'delivering') {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'active');
    updateTimelineStatus('delivered', 'pending');
  } else if (statusLower === 'delivered') {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'completed');
    updateTimelineStatus('delivered', 'completed');
  } else if (statusLower === 'cancelled') {
    updateTimelineStatus('preparing', 'pending');
    updateTimelineStatus('on-the-way', 'pending');
    updateTimelineStatus('delivered', 'pending');
  }
}

/**
 * Update individual timeline dot status
 */
function updateTimelineStatus(stageId, status) {
  const dot = document.getElementById(`dot-${stageId}`);
  if (!dot) return;

  dot.className = `timeline-dot ${status}`;

  const timeEl = document.getElementById(`time-${stageId}`);
  if (timeEl) {
    if (status === 'active') {
      timeEl.textContent = 'In progress...';
    } else if (status === 'completed') {
      timeEl.textContent = 'Completed';
    } else {
      timeEl.textContent = 'Pending';
    }
  }
}

function handleOrderUpdate(payload) {
  if (!payload) return;
  
  const updatedId = payload.order_id || payload.id || payload.orderId;
  if (!updatedId) return;

  console.log('üì¶ Order update received:', updatedId, payload);

  const existingIndex = allOrders.findIndex(order => {
    const orderId = order.order_id || order.id;
    return orderId && String(orderId) === String(updatedId);
  });

  if (existingIndex !== -1) {
    allOrders[existingIndex] = { ...allOrders[existingIndex], ...payload };
  } else {
    allOrders.unshift(payload);
  }

  filterOrders(currentFilter);

  if (trackingOrderId && String(trackingOrderId) === String(updatedId)) {
    updateTrackingModalWithOrder(payload);
  }

  showToast(`Order #${updatedId} updated`, 'info');
}

function handleLocationUpdate(locationData) {
  if (!trackingOrderId || !locationData) return;

  const orderId = locationData.order_id || locationData.orderId;
  if (String(orderId) !== String(trackingOrderId)) return;

  if (locationData.latitude && locationData.longitude && riderMarker && trackingMap) {
    const newPos = [locationData.latitude, locationData.longitude];
    riderMarker.setLatLng(newPos);
    
    if (locationData.eta) {
      const etaEl = document.getElementById('eta-display');
      if (etaEl) etaEl.textContent = `${locationData.eta} mins`;
    }
  }
}

function handleNewOrder(orderData) {
  if (!orderData) return;

  const orderId = orderData.order_id || orderData.id;
  if (!orderId) return;

  const exists = allOrders.find(order => {
    const id = order.order_id || order.id;
    return id && String(id) === String(orderId);
  });

  if (!exists) {
    allOrders.unshift(orderData);
    filterOrders(currentFilter);
    showToast(`New order #${orderId} received!`, 'success');
  }
}

function formatDateTime(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch {
    return 'Just now';
  }
}

// ============================================
// ORDER TRACKING - MODAL
// ============================================

/**
 * Start tracking an order - opens modal and joins tracking room
 */
function startTracking(orderId) {
  const order = allOrders.find(o => {
    const id = o.order_id || o.id;
    return id && String(id) === String(orderId);
  });

  if (!order) {
    showToast('Order not found. Please refresh the page.', 'error');
    return;
  }

  trackingOrderId = orderId;
  showTrackingModal(order);

  // Emit track-order event to join order-specific room via Socket.IO
  if (socket && socket.connected) {
    socket.emit('track-order', { orderId });
    console.log(`üì° Tracking order via Socket.IO: ${orderId}`);
  } else {
    console.warn('‚ö†Ô∏è Socket not connected');
  }

  startTrackingPolling();
}

/**
 * Display tracking modal with map and timeline
 */
function showTrackingModal(order) {
  const existing = document.getElementById('tracking-modal');
  if (existing) existing.remove();

  const orderId = order.order_id || order.id || 'N/A';
  const total = parseFloat(order.total || 0).toFixed(2);
  const deliveryFee = parseFloat(order.delivery_fee || 30).toFixed(2);
  const grandTotal = (parseFloat(total)).toFixed(2);

  const modal = document.createElement('div');
  modal.id = 'tracking-modal';
  modal.className = 'fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto';
  modal.innerHTML = `
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-6xl overflow-hidden my-8">
      <div class="flex justify-between items-center bg-gradient-to-r from-accent to-accent-dark text-white p-5">
        <div>
          <h3 class="text-2xl font-bold">üö¥ Tracking Order #${escapeHtml(orderId)}</h3>
          <p class="text-sm text-white/80 mt-1">Real-time delivery tracking</p>
        </div>
        <button id="tracking-close-btn" class="hover:bg-white/20 rounded-full p-2 transition-all">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
        <div class="lg:col-span-2">
          <div id="tracking-map" class="rounded-2xl overflow-hidden border-4 border-gray-100"></div>
          
          <!-- Progress Bar Container (added dynamically via Socket.IO event) -->
          
          <div class="mt-4 bg-gradient-to-r from-green-500 to-green-600 rounded-xl p-4 text-white text-center eta-badge">
            <div class="flex items-center justify-center gap-3">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <div>
                <p class="text-sm opacity-90">Estimated Arrival</p>
                <p id="eta-display" class="text-2xl font-bold">Calculating...</p>
              </div>
            </div>
          </div>
        </div>
        <div class="lg:col-span-1">
          <div class="bg-gradient-to-br from-cream/50 to-accent-light/20 rounded-2xl p-6 h-full">
            <h4 class="text-xl font-bold text-dark mb-6 flex items-center gap-2">
              <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              Order Timeline
            </h4>
            
            <!-- Message Box Container (added dynamically via Socket.IO event) -->
            
            <div id="order-timeline" class="space-y-0"></div>
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h5 class="font-bold text-dark mb-3">Order Details</h5>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600">Total:</span>
                  <span class="font-semibold">‚Ç±${total}</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600">Delivery Fee:</span>
                  <span class="font-semibold">‚Ç±${deliveryFee}</span>
                </div>
                <div class="flex justify-between pt-2 border-t border-gray-200">
                  <span class="font-bold">Grand Total:</span>
                  <span class="font-bold text-accent">‚Ç±${grandTotal}</span>
                </div>
              </div>
            </div>
            <button id="contact-rider-btn" class="w-full mt-4 bg-gradient-to-r from-accent to-accent-dark text-white py-3 rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
              Contact Support
            </button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.appendChild(modal);

  const closeBtn = document.getElementById('tracking-close-btn');
  if (closeBtn) {
    closeBtn.addEventListener('click', stopTracking);
  }

  const contactBtn = document.getElementById('contact-rider-btn');
  if (contactBtn) {
    contactBtn.addEventListener('click', () => {
      showToast('Contact support: support@kusinanikatya.com', 'info');
    });
  }

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      stopTracking();
    }
  });

  setTimeout(() => initializeTracking(order), 100);
}

/**
 * Initialize map and tracking visualization
 */
function initializeTracking(order) {
  try {
    if (trackingMap) {
      try {
        trackingMap.remove();
      } catch (err) {
        console.error('Error removing map:', err);
      }
      trackingMap = null;
    }

    const mapEl = document.getElementById('tracking-map');
    if (!mapEl) {
      console.error('Map element not found');
      return;
    }

    trackingMap = L.map('tracking-map', { 
      zoomControl: true,
      scrollWheelZoom: false 
    }).setView(RESTAURANT_LOCATION, 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(trackingMap);

    const restaurantIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="background: #cda45e; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"><span style="font-size:18px">üçΩÔ∏è</span></div>',
      iconSize: [40, 40]
    });
    restaurantMarker = L.marker(RESTAURANT_LOCATION, { icon: restaurantIcon }).addTo(trackingMap);
    restaurantMarker.bindPopup('<b>Kusina ni Katya</b><br>Restaurant Location');

    let customerLoc = getCustomerLocation(order);

    const customerIcon = L.divIcon({
      className: 'custom-marker',
      html: '<div style="background: #10b981; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"><span style="font-size:18px">üìç</span></div>',
      iconSize: [40, 40]
    });
    customerMarker = L.marker(customerLoc, { icon: customerIcon }).addTo(trackingMap);
    customerMarker.bindPopup('<b>Delivery Location</b><br>Your address');

    generateRoutePoints(RESTAURANT_LOCATION, customerLoc);

    routeLine = L.polyline(routePoints, { 
      color: '#cda45e', 
      weight: 4, 
      opacity: 0.7,
      dashArray: '10, 5'
    }).addTo(trackingMap);

    const riderIcon = L.divIcon({
      className: 'custom-marker rider-marker',
      html: '<div style="background: #3b82f6; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"><span style="font-size:20px">üö¥</span></div>',
      iconSize: [45, 45]
    });

    if (riderMarker) {
      try {
        trackingMap.removeLayer(riderMarker);
      } catch {}
    }

    riderMarker = L.marker(routePoints[0], { icon: riderIcon }).addTo(trackingMap);
    riderMarker.bindPopup('<b>Rider</b><br>On the way!');

    const group = L.featureGroup([restaurantMarker, customerMarker, routeLine]);
    trackingMap.fitBounds(group.getBounds().pad(0.1));

    renderTimeline(order);
    startRiderSimulation();

  } catch (error) {
    console.error('Error initializing tracking:', error);
    showToast('Failed to initialize map. Please try again.', 'error');
    stopTracking();
  }
}

function getCustomerLocation(order) {
  try {
    if (order.delivery_coordinates) {
      const coords = order.delivery_coordinates;
      
      if (Array.isArray(coords) && coords.length >= 2) {
        const lat = parseFloat(coords[0]);
        const lng = parseFloat(coords[1]);
        if (!isNaN(lat) && !isNaN(lng)) {
          console.log('‚úÖ Using array coordinates:', [lat, lng]);
          return [lat, lng];
        }
      }
      
      if (typeof coords === 'string') {
        try {
          const parsed = JSON.parse(coords);
          if (Array.isArray(parsed) && parsed.length >= 2) {
            const lat = parseFloat(parsed[0]);
            const lng = parseFloat(parsed[1]);
            if (!isNaN(lat) && !isNaN(lng)) {
              console.log('‚úÖ Using parsed string coordinates:', [lat, lng]);
              return [lat, lng];
            }
          }
          if (parsed.lat && parsed.lng) {
            const lat = parseFloat(parsed.lat || parsed.latitude);
            const lng = parseFloat(parsed.lng || parsed.longitude);
            if (!isNaN(lat) && !isNaN(lng)) {
              console.log('‚úÖ Using object coordinates:', [lat, lng]);
              return [lat, lng];
            }
          }
        } catch (e) {
          const match = coords.match(/(-?\d+\.?\d*),\s*(-?\d+\.?\d*)/);
          if (match) {
            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);
            if (!isNaN(lat) && !isNaN(lng)) {
              console.log('‚úÖ Using regex-matched coordinates:', [lat, lng]);
              return [lat, lng];
            }
          }
        }
      }
      
      if (typeof coords === 'object' && coords !== null) {
        const lat = parseFloat(coords.lat || coords.latitude);
        const lng = parseFloat(coords.lng || coords.longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          console.log('‚úÖ Using object coordinates:', [lat, lng]);
          return [lat, lng];
        }
      }
    }
    
    if (order.delivery_location) {
      const loc = order.delivery_location;
      
      if (Array.isArray(loc) && loc.length >= 2) {
        const lat = parseFloat(loc[0]);
        const lng = parseFloat(loc[1]);
        if (!isNaN(lat) && !isNaN(lng)) {
          console.log('‚úÖ Using delivery_location array:', [lat, lng]);
          return [lat, lng];
        }
      }
      
      if (typeof loc === 'string') {
        try {
          const parsed = JSON.parse(loc);
          if (Array.isArray(parsed) && parsed.length >= 2) {
            const lat = parseFloat(parsed[0]);
            const lng = parseFloat(parsed[1]);
            if (!isNaN(lat) && !isNaN(lng)) {
              console.log('‚úÖ Using parsed delivery_location:', [lat, lng]);
              return [lat, lng];
            }
          }
        } catch {}
      }
      
      if (typeof loc === 'object' && loc !== null) {
        const lat = parseFloat(loc.lat || loc.latitude);
        const lng = parseFloat(loc.lng || loc.longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          console.log('‚úÖ Using delivery_location object:', [lat, lng]);
          return [lat, lng];
        }
      }
    }

    if (order.latitude && order.longitude) {
      const lat = parseFloat(order.latitude);
      const lng = parseFloat(order.longitude);
      if (!isNaN(lat) && !isNaN(lng)) {
        console.log('‚úÖ Using order.latitude/longitude:', [lat, lng]);
        return [lat, lng];
      }
    }

    if (order.lat && order.lng) {
      const lat = parseFloat(order.lat);
      const lng = parseFloat(order.lng);
      if (!isNaN(lat) && !isNaN(lng)) {
        console.log('‚úÖ Using order.lat/lng:', [lat, lng]);
        return [lat, lng];
      }
    }

  } catch (err) {
    console.error('‚ùå Error parsing location:', err);
  }

  const randomLat = RESTAURANT_LOCATION[0] + (Math.random() - 0.5) * 0.02;
  const randomLng = RESTAURANT_LOCATION[1] + (Math.random() - 0.5) * 0.02;
  
  console.log('‚ö†Ô∏è Using fallback random location:', [randomLat, randomLng]);
  
  return [randomLat, randomLng];
}

function generateRoutePoints(start, end) {
  routePoints = [];
  const steps = 60;

  for (let i = 0; i <= steps; i++) {
    const t = i / steps;
    const lat = start[0] + (end[0] - start[0]) * t + Math.sin(t * Math.PI * 2) * 0.003;
    const lng = start[1] + (end[1] - start[1]) * t + Math.cos(t * Math.PI * 2) * 0.003;
    routePoints.push([lat, lng]);
  }
}

function startRiderSimulation() {
  currentRiderIndex = 0;
  stopRiderSimulation();

  riderSimulationInterval = setInterval(() => {
    if (!routePoints || routePoints.length === 0 || !riderMarker || !trackingMap) {
      stopRiderSimulation();
      return;
    }

    if (currentRiderIndex < routePoints.length - 1) {
      currentRiderIndex++;
      const newPos = routePoints[currentRiderIndex];
      riderMarker.setLatLng(newPos);

      const progress = currentRiderIndex / (routePoints.length - 1);
      const remainingMins = Math.max(1, Math.ceil(20 * (1 - progress)));

      const etaEl = document.getElementById('eta-display');
      if (etaEl) {
        etaEl.textContent = remainingMins > 1 ? `${remainingMins} mins` : 'Arriving soon!';
      }

      updateTimelineByProgress(progress);

    } else {
      stopRiderSimulation();
      updateTimelineStatus('delivered', 'completed');
      const etaEl = document.getElementById('eta-display');
      if (etaEl) etaEl.textContent = 'Delivered!';
    }
  }, 400);
}

function stopRiderSimulation() {
  if (riderSimulationInterval) {
    clearInterval(riderSimulationInterval);
    riderSimulationInterval = null;
  }
}

function updateTimelineByProgress(progress) {
  if (progress > 0.2 && progress < 0.4) {
    updateTimelineStatus('preparing', 'active');
  } else if (progress >= 0.4 && progress < 0.95) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'active');
  } else if (progress >= 0.95) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'completed');
    updateTimelineStatus('delivered', 'active');
  }
}

/**
 * Render timeline with current order status
 */
function renderTimeline(order) {
  const timeline = document.getElementById('order-timeline');
  if (!timeline) return;

  const createdDate = order.created_at ? formatDateTime(order.created_at) : '';

  const stages = [
    { id: 'order-placed', icon: 'üìã', label: 'Order Placed', status: 'completed', time: createdDate },
    { id: 'preparing', icon: 'üë®‚Äçüç≥', label: 'Preparing Food', status: 'pending', time: '' },
    { id: 'on-the-way', icon: 'üö¥', label: 'On the Way', status: 'pending', time: '' },
    { id: 'delivered', icon: '‚úÖ', label: 'Delivered', status: 'pending', time: '' }
  ];

  const deliveryStatus = (order.delivery_status || '').toLowerCase();
  
  if (deliveryStatus.includes('prepar')) {
    stages[1].status = 'active';
  } else if (deliveryStatus.includes('deliver') || deliveryStatus.includes('way')) {
    stages[1].status = 'completed';
    stages[2].status = 'active';
  } else if (deliveryStatus === 'delivered') {
    stages[1].status = 'completed';
    stages[2].status = 'completed';
    stages[3].status = 'completed';
  }

  timeline.innerHTML = stages.map(stage => `
    <div class="timeline-item" data-stage="${stage.id}">
      <div class="timeline-dot ${stage.status}" id="dot-${stage.id}"></div>
      <div class="timeline-content">
        <div class="flex items-start justify-between">
          <div>
            <h6 class="font-bold text-dark text-sm mb-1">${stage.icon} ${stage.label}</h6>
            <p class="text-xs text-gray-500" id="time-${stage.id}">
              ${stage.time || (stage.status === 'completed' ? 'Completed' : stage.status === 'active' ? 'In progress' : 'Pending')}
            </p>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function startTrackingPolling() {
  stopTrackingPolling();

  trackingInterval = setInterval(async () => {
    if (!trackingOrderId) {
      stopTrackingPolling();
      return;
    }

    const order = allOrders.find(o => {
      const id = o.order_id || o.id;
      return id && String(id) === String(trackingOrderId);
    });

    if (order) {
      updateTrackingModalWithOrder(order);
    }
  }, 5000);
}

function stopTrackingPolling() {
  if (trackingInterval) {
    clearInterval(trackingInterval);
    trackingInterval = null;
  }
}

function updateTrackingModalWithOrder(order) {
  if (!order) return;

  const deliveryStatus = (order.delivery_status || '').toLowerCase();
  
  if (deliveryStatus.includes('prepar')) {
    updateTimelineStatus('preparing', 'active');
  } else if (deliveryStatus.includes('deliver') || deliveryStatus.includes('way')) {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'active');
  } else if (deliveryStatus === 'delivered') {
    updateTimelineStatus('preparing', 'completed');
    updateTimelineStatus('on-the-way', 'completed');
    updateTimelineStatus('delivered', 'completed');
    
    const etaEl = document.getElementById('eta-display');
    if (etaEl) etaEl.textContent = 'Delivered!';
    
    stopRiderSimulation();
  }
}

/**
 * Stop tracking and clean up resources
 */
function stopTracking() {
  const modal = document.getElementById('tracking-modal');
  if (modal) {
    modal.remove();
  }

  if (socket && socket.connected && trackingOrderId) {
    socket.emit('stop-tracking', { orderId: trackingOrderId });
  }

  if (trackingMap) {
    try {
      trackingMap.remove();
    } catch (err) {
      console.error('Error removing map:', err);
    }
    trackingMap = null;
  }

  stopTrackingPolling();
  stopRiderSimulation();

  trackingOrderId = null;
  restaurantMarker = null;
  customerMarker = null;
  riderMarker = null;
  routeLine = null;
  currentRiderIndex = 0;
  routePoints = [];
}

// ============================================
// SILENT REFRESH
// ============================================
function startSilentRefresh() {
  stopSilentRefresh();
  refreshTimer = setInterval(() => {
    if (isUserAuthenticated()) {
      loadOrders(false);
    }
  }, SILENT_REFRESH_MS);
}

function stopSilentRefresh() {
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
}

// ============================================
// PAYMENT RETURN HANDLER
// ============================================
/**
 * Handle payment return from PayMongo 3DS redirect or GCash
 * PayMongo redirects back with payment_intent and payment_intent_client_secret (card) or payment=success/failed (GCash)
 */
async function handlePaymentReturn() {
  const urlParams = new URLSearchParams(window.location.search);
  const paymentIntent = urlParams.get('payment_intent');
  const paymentIntentClientSecret = urlParams.get('payment_intent_client_secret');
  const paymentStatus = urlParams.get('payment'); // GCash returns: 'success' or 'failed'
  
  // Handle card payment return (3DS)
  if (paymentIntent || paymentIntentClientSecret) {
    console.log('üí∞ Card payment return detected:', { paymentIntent, paymentIntentClientSecret });
    
    // Check if there's pending order data from cart.html
    const pendingOrderData = sessionStorage.getItem('pendingOrderData');
    const pendingPaymentIntentId = sessionStorage.getItem('pendingPaymentIntentId');
    
    if (pendingOrderData && pendingPaymentIntentId) {
      try {
        // Get auth token
        const token = getAuthToken();
        
        if (!token) {
          throw new Error('No authentication token found');
        }
        
        const API_URL = window.location.hostname === 'localhost' 
          ? 'http://localhost:3000/api' 
          : '/api';
        
        // Parse order data
        const orderData = JSON.parse(pendingOrderData);
        
        // Verify payment intent matches
        if (orderData.payment_intent_id !== pendingPaymentIntentId) {
          console.warn('‚ö†Ô∏è Payment intent ID mismatch');
        }
        
        // Update payment status based on return
        orderData.payment_status = 'paid';
        
        // Create the order
        const orderResponse = await fetch(`${API_URL}/create-order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(orderData)
        });
        
        const result = await orderResponse.json();
        
        if (!orderResponse.ok || !result.success) {
          throw new Error(result.message || 'Failed to create order');
        }
        
        console.log('‚úÖ Order created after payment:', result.order_id);
        
        // Clear pending data
        sessionStorage.removeItem('pendingOrderData');
        sessionStorage.removeItem('pendingPaymentIntentId');
        
        // Show success message
        showToast('‚úÖ Payment successful! Order created.', 'success');
        
        // Clean up URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Reload orders to show the new order
        await loadOrders(true);
        
      } catch (error) {
        console.error('‚ùå Error completing order after payment:', error);
        showToast('Payment completed but error creating order. Please contact support.', 'error');
        
        // Clean up URL parameters
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    } else {
      // No pending order, just show success and reload orders
      showToast('‚úÖ Payment authorization completed!', 'success');
      
      // Clean up URL parameters
      window.history.replaceState({}, document.title, window.location.pathname);
      
      // Reload orders
      await loadOrders(true);
    }
  }
  // Handle GCash payment return
  else if (paymentStatus === 'success' || paymentStatus === 'failed') {
    console.log('üí∞ GCash payment return detected:', paymentStatus);
    
    // Check for pending GCash order
    const pendingGCashOrder = sessionStorage.getItem('pendingGCashOrder');
    
    if (paymentStatus === 'success') {
      if (pendingGCashOrder) {
        showToast('‚úÖ GCash payment successful! Order status updated.', 'success');
      } else {
        showToast('‚úÖ GCash payment successful!', 'success');
      }
      // Reload orders to show updated status
      await loadOrders(true);
    } else {
      showToast('‚ùå GCash payment failed. Please try again.', 'error');
      setTimeout(() => {
        window.location.href = 'cart.html';
      }, 3000);
    }
    
    // Clean up
    sessionStorage.removeItem('pendingGCashOrder');
    window.history.replaceState({}, document.title, window.location.pathname);
  }
}

// ============================================
// PAGE INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ Orders page initializing...');

  if (!isUserAuthenticated()) {
    redirectToLogin();
    return;
  }

  // Handle payment return first (must be before loadOrders)
  await handlePaymentReturn();

  updateUIForUser();
  loadCartCount();
  initializeSocket(); // Initialize Socket.IO for real-time updates
  await loadOrders(true);
  startSilentRefresh();

  console.log('‚úÖ Orders page initialized successfully');
});

// ============================================
// CLEANUP ON PAGE UNLOAD
// ============================================
window.addEventListener('beforeunload', () => {
  stopTracking();
  stopSilentRefresh();
  
  if (socket && socket.connected) {
    socket.disconnect();
  }
});

console.log('‚úÖ Orders page script loaded');
</script>
</body>
</html>